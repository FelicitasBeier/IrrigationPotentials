---
title: "Long-term Technical and Economic Irrigation Potentials around 2010"
author: "Felicitas Beier"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r Setup, include=FALSE}
# R markdown set-up
knitr::opts_chunk$set(echo = TRUE)

# mr universe functions
library(madrat)
library(magclass)
library(mrwater)
library(mrcommons)

# raster functions 
library(raster)
library(sp)

# terra functions
library(terra)
library(sf) 

# plot functions
library(ggplot2)
library(ggpubr)
library(plotrix)

# tables
library(xtable) # latex

```

```{r Settings0, include=FALSE}
version  <- "mrwaterFullOutputs_resubmission"
year     <- "y2010"
scenario <- "ssp2"

# Path
filepath       <- paste0(getwd(), "/inputdata/")
inputdatapath  <- paste0(getwd(), "/inputdata/", version, "/")
outputdatapath <- paste0(getwd(), "/outputs/", version, "/")

```

## Current Irrigation

```{r ReadinCurrent, include = FALSE, echo = FALSE}
# Current cropland and currently irrigated areas according to LUH
LUHarea      <- setYears(dimSums(collapseNames(read.magpie(paste0(inputdatapath, "cropareaLUH", ".mz"))), 
                                 dim = "crop"), year) 
LUHirrigated <- collapseNames(LUHarea[, , "irrigated"])
LUHtotal     <- dimSums(LUHarea, dim = "irrigation")

# Current irrigated area with EFR=on and off
irrigAreaCurrent <- collapseNames(read.magpie(paste0(inputdatapath, "irrigAreaCurrent.mz"))[,,scenario][,,"irrigatable"])

# water committed to current agricultural use (in mio. m^3) 
watComAg     <- dimSums(read.magpie(paste0(inputdatapath, "watComAg", ".mz")), dim = "crop")
# committed agricultural withdrawal and consumption (in mio. km^3)
watComAgWW   <- collapseNames(watComAg[,,"withdrawal"]) / 1000 
watComAgWC   <- collapseNames(watComAg[,,"consumption"]) / 1000

# Committed agricultural fulfilled uses (in mio. km^3)
comAgWW      <- collapseNames(read.magpie(paste0(inputdatapath, "comAguses.mz"))[,,scenario][,,"currHuman_ww"]) / 1000
comAgWC      <- collapseNames(read.magpie(paste0(inputdatapath, "comAguses.mz"))[,,scenario][,,"currHuman_wc"]) / 1000
comAgWCoff   <- collapseNames(comAgWC[,,"off"])
comAgWCon    <- collapseNames(comAgWC[,,"on"])

# Non-agricultural uses (in mio. km^3)
watNonAgWW   <- collapseNames(read.magpie(paste0(inputdatapath, "nonAguses.mz"))[,,scenario][,,"currHuman_ww"]) / 1000
watNonAgWC   <- collapseNames(read.magpie(paste0(inputdatapath, "nonAguses.mz"))[,,scenario][,,"currHuman_wc"]) / 1000
```

```{r ReportCurrentArea, include=TRUE, echo=FALSE}
writeLines(paste0("Globally, an area of ", round(dimSums(LUHirrigated, dim = 1)), " Mha is reported to be irrigated according to LUH. \nOf these irrigated areas, ", round(dimSums(irrigAreaCurrent[,,"off"], dim = 1)), " Mha could be fulfilled \ngiven the local water availability in this study. \nIF EFR were to be maintained, it would be ", round(dimSums(irrigAreaCurrent[,,"on"], dim = 1)), " Mha.")) 
```

```{r ReportCurrentVolume, include=TRUE, echo=FALSE}
writeLines(paste0("Globally, a consumptive water volume of ", round(dimSums(watComAgWC, dim = 1)), " km3/yr is required to irrigate \nthe given cropmix (FAO country-level production pattern of 2010) on currently irrigated areas to its full potential. \nOf these irrigation water requirements, ", round(dimSums(comAgWCoff, dim = 1)), " km3/yr could be fulfilled \ngiven the local water availability in this study. \nThis volume would be reduced to ", round(dimSums(comAgWCon, dim = 1)), " km3/yr if the EFR were to be maintained."))
```

To calculate total (un)sustainable water uses in order to compare the value with the planetary boundary, 
the following non-agricultural uses have to be added to the Irrigation Potentials, respectively:

```{r NonAgUses, include=TRUE, echo=FALSE}
print(paste0("Global non-ag. consumption (unsustainable): ", round(dimSums(watNonAgWC[,,"off"], dim = 1)), " km^3/yr"))
print(paste0("Global non-ag. consumption (sustainable): ", round(dimSums(watNonAgWC[,,"on"], dim = 1)), " km^3/yr"))
```


## Aggregated Economic Irrigation Potentials

For the correct interpretation of the marginal return to irrigation,
the committed agricultural uses river routing iteration must be switched off.
Otherwise, these areas are pre-reserved and their reported willingness-to-pay 
for irrigation would not represent the true value of irrigation
in these locations. 

The tables PIA_bycountry_b.csv, PIWW_bycountry_b.csv, and PIWC_bycountry_b.csv 
in the supplementary information (SI) provide these purely economically 
determined irrigation potentials without consideration of areas that are already
today under irrigation (committed agricultural uses).
They are also the basis for the country- and basin-level IAD curves and 
economic PIA maps. 

```{r SCENARIOdata, include=FALSE, echo=FALSE}
# Current irrigated area (IRR)
IrrigAreaEconIRRSUS    <- read.magpie(paste0(inputdatapath, "IrrigAreaEconACTSUS", ".mz"))
IrrigAreaEconIRRUNSUS  <- read.magpie(paste0(inputdatapath, "IrrigAreaEconACTUNSUS", ".mz"))

wat_ag_wcEconIRRSUS    <- read.magpie(paste0(inputdatapath, "wat_ag_wcEconACTSUS", ".mz"))
wat_ag_wcEconIRRUNSUS  <- read.magpie(paste0(inputdatapath, "wat_ag_wcEconACTUNSUS", ".mz"))

wat_ag_wwEconIRRSUS    <- read.magpie(paste0(inputdatapath, "wat_ag_wwEconACTSUS", ".mz"))
wat_ag_wwEconIRRUNSUS  <- read.magpie(paste0(inputdatapath, "wat_ag_wwEconACTUNSUS", ".mz"))

yieldgainareaIRRunsus  <- read.magpie(paste0(inputdatapath, "yieldgainarea_actUNSUS.mz"))
yieldgainareaIRRsus    <- read.magpie(paste0(inputdatapath, "yieldgainarea_actSUS.mz"))

yieldgainwaterIRRunsus <- read.magpie(paste0(inputdatapath, "yieldgainwater_actUNSUS.mz")) / 1000
yieldgainwaterIRRsus   <- read.magpie(paste0(inputdatapath, "yieldgainwater_actSUS.mz")) / 1000

# Current cropland area (CUR)
IrrigAreaEconCURSUS    <- read.magpie(paste0(inputdatapath, "IrrigAreaEconCURSUS", ".mz"))
IrrigAreaEconCURUNSUS  <- read.magpie(paste0(inputdatapath, "IrrigAreaEconCURUNSUS", ".mz"))

wat_ag_wcEconCURSUS    <- read.magpie(paste0(inputdatapath, "wat_ag_wcEconCURSUS", ".mz"))
wat_ag_wcEconCURUNSUS  <- read.magpie(paste0(inputdatapath, "wat_ag_wcEconCURUNSUS", ".mz"))

wat_ag_wwEconCURSUS    <- read.magpie(paste0(inputdatapath, "wat_ag_wwEconCURSUS", ".mz"))
wat_ag_wwEconCURUNSUS  <- read.magpie(paste0(inputdatapath, "wat_ag_wwEconCURUNSUS", ".mz"))

yieldgainareaCURunsus  <- read.magpie(paste0(inputdatapath, "yieldgainarea_curUNSUS.mz"))
yieldgainareaCURsus    <- read.magpie(paste0(inputdatapath, "yieldgainarea_curSUS.mz"))

yieldgainwaterCURunsus <- read.magpie(paste0(inputdatapath, "yieldgainwater_curUNSUS.mz")) / 1000
yieldgainwaterCURsus   <- read.magpie(paste0(inputdatapath, "yieldgainwater_curSUS.mz")) / 1000

# Potential cropland area (POT)
IrrigAreaEconPOTSUS    <- read.magpie(paste0(inputdatapath, "IrrigAreaEconPOTSUS", ".mz"))
IrrigAreaEconPOTUNSUS  <- read.magpie(paste0(inputdatapath, "IrrigAreaEconPOTUNSUS", ".mz"))

wat_ag_wcEconPOTSUS    <- read.magpie(paste0(inputdatapath, "wat_ag_wcEconPOTSUS", ".mz"))
wat_ag_wcEconPOTUNSUS  <- read.magpie(paste0(inputdatapath, "wat_ag_wcEconPOTUNSUS", ".mz"))

wat_ag_wwEconPOTSUS    <- read.magpie(paste0(inputdatapath, "wat_ag_wwEconPOTSUS", ".mz"))
wat_ag_wwEconPOTUNSUS  <- read.magpie(paste0(inputdatapath, "wat_ag_wwEconPOTUNSUS", ".mz"))

yieldgainareaPOTunsus  <- read.magpie(paste0(inputdatapath, "yieldgainarea_potUNSUS.mz"))
yieldgainareaPOTsus    <- read.magpie(paste0(inputdatapath, "yieldgainarea_potSUS.mz"))

yieldgainwaterPOTunsus <- read.magpie(paste0(inputdatapath, "yieldgainwater_potUNSUS.mz")) / 1000
yieldgainwaterPOTsus   <- read.magpie(paste0(inputdatapath, "yieldgainwater_potSUS.mz")) / 1000

```


```{r OverviewTables, include=FALSE, echo=FALSE}
# Extract reported yield gain thresholds
gt <- getNames(collapseNames(IrrigAreaEconIRRSUS[,,"on"]))

## Irrigated Area (PIA = Potentially Irrigated Areas) [mio. ha]
i <- 0

for (g in gt) {

  # Actually Irrigated Land
  data <- as.data.frame(dimSums(yieldgainareaIRRunsus[,,g], dim = c(1.1, 1.2)))
  data <- data.frame(Country = data$Region, "IRR-NOLIM" = data$Value, GT = g)
  
  tmp  <- as.data.frame(dimSums(IrrigAreaEconIRRUNSUS[,,"off"][,,g], dim = c(1.1, 1.2)))
  tmp  <- data.frame(Country = tmp$Region, "IRR-UNSUS" = tmp$Value, GT = g)
  data <- merge(data, tmp)
  
  tmp  <- as.data.frame(dimSums(IrrigAreaEconIRRUNSUS[,,"on"][,,g], dim = c(1.1, 1.2)))
  tmp  <- data.frame(Country = tmp$Region, "IRR-WATSUS" = tmp$Value, GT = g)
  data <- merge(data, tmp)
  
  tmp  <- as.data.frame(dimSums(IrrigAreaEconIRRSUS[,,"off"][,,g], dim = c(1.1, 1.2)))
  tmp  <- data.frame(Country = tmp$Region, "IRR-LANDSUS" = tmp$Value, GT = g)
  data <- merge(data, tmp)
  
  tmp  <- as.data.frame(dimSums(IrrigAreaEconIRRSUS[,,"on"][,,g], dim = c(1.1, 1.2)))
  tmp  <- data.frame(Country = tmp$Region, "IRR-SUS" = tmp$Value, GT = g)
  data <- merge(data, tmp)
  
  # Current Cropland
  tmp  <- as.data.frame(dimSums(yieldgainareaCURunsus[,,g], dim = c(1.1, 1.2)))
  tmp  <- data.frame(Country = tmp$Region, "CUR-NOLIM" = tmp$Value, GT = g)
  data <- merge(data, tmp)
  
  tmp  <- as.data.frame(dimSums(IrrigAreaEconCURUNSUS[,,"off"][,,g], dim = c(1.1, 1.2)))
  tmp  <- data.frame(Country = tmp$Region, "CUR-UNSUS" = tmp$Value, GT = g)
  data <- merge(data, tmp)
  
  tmp  <- as.data.frame(dimSums(IrrigAreaEconCURUNSUS[,,"on"][,,g], dim = c(1.1, 1.2)))
  tmp  <- data.frame(Country = tmp$Region, "CUR-WATSUS" = tmp$Value, GT = g)
  data <- merge(data, tmp)
  
  tmp  <- as.data.frame(dimSums(IrrigAreaEconCURSUS[,,"off"][,,g], dim = c(1.1, 1.2)))
  tmp  <- data.frame(Country = tmp$Region, "CUR-LANDSUS" = tmp$Value, GT = g)
  data <- merge(data, tmp)
  
  tmp  <- as.data.frame(dimSums(IrrigAreaEconCURSUS[,,"on"][,,g], dim = c(1.1, 1.2)))
  tmp  <- data.frame(Country = tmp$Region, "CUR-SUS" = tmp$Value, GT = g)
  data <- merge(data, tmp)
  
  # Potential cropland
  tmp  <- as.data.frame(dimSums(yieldgainareaPOTunsus[,,g], dim = c(1.1, 1.2)))
  tmp  <- data.frame(Country = tmp$Region, "POT-NOLIM" = tmp$Value, GT = g)
  data <- merge(data, tmp)
  
  tmp  <- as.data.frame(dimSums(IrrigAreaEconPOTUNSUS[,,"off"][,,g], dim = c(1.1, 1.2)))
  tmp  <- data.frame(Country = tmp$Region, "POT-UNSUS" = tmp$Value, GT = g)
  data <- merge(data, tmp)
  
  tmp  <- as.data.frame(dimSums(IrrigAreaEconPOTUNSUS[,,"on"][,,g], dim = c(1.1, 1.2)))
  tmp  <- data.frame(Country = tmp$Region, "POT-WATSUS" = tmp$Value, GT = g)
  data <- merge(data, tmp)
  
  tmp  <- as.data.frame(dimSums(IrrigAreaEconPOTSUS[,,"off"][,,g], dim = c(1.1, 1.2)))
  tmp  <- data.frame(Country = tmp$Region, "POT-LANDSUS" = tmp$Value, GT = g)
  data <- merge(data, tmp)
  
  tmp  <- as.data.frame(dimSums(IrrigAreaEconPOTSUS[,,"on"][,,g], dim = c(1.1, 1.2)))
  tmp  <- data.frame(Country = tmp$Region, "POT-SUS" = tmp$Value, GT = g)
  data <- merge(data, tmp)
  
  if (i == 0) {
    PIA <- data
  } else {
    PIA <- rbind(PIA, data)
  }
  i <- i + 1
}

## Irrigated Water Consumption (PIWC = Potential Irrigation Water Consumption) [mio. m^3]
i <- 0

for (g in gt) {

  # Actually Irrigated Land
  data <- as.data.frame(dimSums(yieldgainwaterIRRunsus[,,"consumption"][,,g], dim = c(1.1, 1.2)))
  data <- data.frame(Country = data$Region, "IRR-NOLIM" = data$Value, GT = g)
  
  tmp  <- as.data.frame(dimSums(wat_ag_wcEconIRRUNSUS[,,"off"][,,g], dim = c(1.1, 1.2)))
  tmp  <- data.frame(Country = tmp$Region, "IRR-UNSUS" = tmp$Value, GT = g)
  data <- merge(data, tmp)
  
  tmp  <- as.data.frame(dimSums(wat_ag_wcEconIRRUNSUS[,,"on"][,,g], dim = c(1.1, 1.2)))
  tmp  <- data.frame(Country = tmp$Region, "IRR-WATSUS" = tmp$Value, GT = g)
  data <- merge(data, tmp)
  
  tmp  <- as.data.frame(dimSums(wat_ag_wcEconIRRSUS[,,"off"][,,g], dim = c(1.1, 1.2)))
  tmp  <- data.frame(Country = tmp$Region, "IRR-LANDSUS" = tmp$Value, GT = g)
  data <- merge(data, tmp)
  
  tmp  <- as.data.frame(dimSums(wat_ag_wcEconIRRSUS[,,"on"][,,g], dim = c(1.1, 1.2)))
  tmp  <- data.frame(Country = tmp$Region, "IRR-SUS" = tmp$Value, GT = g)
  data <- merge(data, tmp)
  
  # Current Cropland
  tmp  <- as.data.frame(dimSums(yieldgainwaterCURunsus[,,"consumption"][,,g], dim = c(1.1, 1.2)))
  tmp  <- data.frame(Country = tmp$Region, "CUR-NOLIM" = tmp$Value, GT = g)
  data <- merge(data, tmp)
  
  tmp  <- as.data.frame(dimSums(wat_ag_wcEconCURUNSUS[,,"off"][,,g], dim = c(1.1, 1.2)))
  tmp  <- data.frame(Country = tmp$Region, "CUR-UNSUS" = tmp$Value, GT = g)
  data <- merge(data, tmp)
  
  tmp  <- as.data.frame(dimSums(wat_ag_wcEconCURUNSUS[,,"on"][,,g], dim = c(1.1, 1.2)))
  tmp  <- data.frame(Country = tmp$Region, "CUR-WATSUS" = tmp$Value, GT = g)
  data <- merge(data, tmp)
  
  tmp  <- as.data.frame(dimSums(wat_ag_wcEconCURSUS[,,"off"][,,g], dim = c(1.1, 1.2)))
  tmp  <- data.frame(Country = tmp$Region, "CUR-LANDSUS" = tmp$Value, GT = g)
  data <- merge(data, tmp)
  
  tmp  <- as.data.frame(dimSums(wat_ag_wcEconCURSUS[,,"on"][,,g], dim = c(1.1, 1.2)))
  tmp  <- data.frame(Country = tmp$Region, "CUR-SUS" = tmp$Value, GT = g)
  data <- merge(data, tmp)
  
  # Potential cropland
  tmp  <- as.data.frame(dimSums(yieldgainwaterPOTunsus[,,"consumption"][,,g], dim = c(1.1, 1.2)))
  tmp  <- data.frame(Country = tmp$Region, "POT-NOLIM" = tmp$Value, GT = g)
  data <- merge(data, tmp)
  
  tmp  <- as.data.frame(dimSums(wat_ag_wcEconPOTUNSUS[,,"off"][,,g], dim = c(1.1, 1.2)))
  tmp  <- data.frame(Country = tmp$Region, "POT-UNSUS" = tmp$Value, GT = g)
  data <- merge(data, tmp)
  
  tmp  <- as.data.frame(dimSums(wat_ag_wcEconPOTUNSUS[,,"on"][,,g], dim = c(1.1, 1.2)))
  tmp  <- data.frame(Country = tmp$Region, "POT-WATSUS" = tmp$Value, GT = g)
  data <- merge(data, tmp)
  
  tmp  <- as.data.frame(dimSums(wat_ag_wcEconPOTSUS[,,"off"][,,g], dim = c(1.1, 1.2)))
  tmp  <- data.frame(Country = tmp$Region, "POT-LANDSUS" = tmp$Value, GT = g)
  data <- merge(data, tmp)
  
  tmp  <- as.data.frame(dimSums(wat_ag_wcEconPOTSUS[,,"on"][,,g], dim = c(1.1, 1.2)))
  tmp  <- data.frame(Country = tmp$Region, "POT-SUS" = tmp$Value, GT = g)
  data <- merge(data, tmp)
  
  if (i == 0) {
    PIWC <- data
  } else {
    PIWC <- rbind(PIWC, data)
  }
  i <- i + 1
}



## Irrigated Water Withdrawals (PIWW = Irrigation Water Withdrawal Potentials) [mio. m^3]
i <- 0

for (g in gt) {

  # Actually Irrigated Land
  data <- as.data.frame(dimSums(yieldgainwaterIRRunsus[,,"withdrawal"][,,g], dim = c(1.1, 1.2)))
  data <- data.frame(Country = data$Region, "IRR-NOLIM" = data$Value, GT = g)
  
  tmp  <- as.data.frame(dimSums(wat_ag_wwEconIRRUNSUS[,,"off"][,,"0"], dim = c(1.1, 1.2)))
  tmp  <- data.frame(Country = tmp$Region, "IRR-UNSUS" = tmp$Value, GT = g)
  data <- merge(data, tmp)
  
  tmp  <- as.data.frame(dimSums(wat_ag_wwEconIRRUNSUS[,,"on"][,,g], dim = c(1.1, 1.2)))
  tmp  <- data.frame(Country = tmp$Region, "IRR-WATSUS" = tmp$Value, GT = g)
  data <- merge(data, tmp)
  
  tmp  <- as.data.frame(dimSums(wat_ag_wwEconIRRSUS[,,"off"][,,g], dim = c(1.1, 1.2)))
  tmp  <- data.frame(Country = tmp$Region, "IRR-LANDSUS" = tmp$Value, GT = g)
  data <- merge(data, tmp)
  
  tmp  <- as.data.frame(dimSums(wat_ag_wwEconIRRSUS[,,"on"][,,g], dim = c(1.1, 1.2)))
  tmp  <- data.frame(Country = tmp$Region, "IRR-SUS" = tmp$Value, GT = g)
  data <- merge(data, tmp)
  
  # Current Cropland
  tmp  <- as.data.frame(dimSums(yieldgainwaterCURunsus[,,"withdrawal"][,,g], dim = c(1.1, 1.2)))
  tmp  <- data.frame(Country = tmp$Region, "CUR-NOLIM" = tmp$Value, GT = g)
  data <- merge(data, tmp)
  
  tmp  <- as.data.frame(dimSums(wat_ag_wwEconCURUNSUS[,,"off"][,,g], dim = c(1.1, 1.2)))
  tmp  <- data.frame(Country = tmp$Region, "CUR-UNSUS" = tmp$Value, GT = g)
  data <- merge(data, tmp)
  
  tmp  <- as.data.frame(dimSums(wat_ag_wwEconCURUNSUS[,,"on"][,,g], dim = c(1.1, 1.2)))
  tmp  <- data.frame(Country = tmp$Region, "CUR-WATSUS" = tmp$Value, GT = g)
  data <- merge(data, tmp)
  
  tmp  <- as.data.frame(dimSums(wat_ag_wwEconCURSUS[,,"off"][,,g], dim = c(1.1, 1.2)))
  tmp  <- data.frame(Country = tmp$Region, "CUR-LANDSUS" = tmp$Value, GT = g)
  data <- merge(data, tmp)
  
  tmp  <- as.data.frame(dimSums(wat_ag_wwEconCURSUS[,,"on"][,,g], dim = c(1.1, 1.2)))
  tmp  <- data.frame(Country = tmp$Region, "CUR-SUS" = tmp$Value, GT = g)
  data <- merge(data, tmp)
  
  # Potential cropland
  tmp  <- as.data.frame(dimSums(yieldgainwaterPOTunsus[,,"withdrawal"][,,g], dim = c(1.1, 1.2)))
  tmp  <- data.frame(Country = tmp$Region, "POT-NOLIM" = tmp$Value, GT = g)
  data <- merge(data, tmp)
  
  tmp  <- as.data.frame(dimSums(wat_ag_wwEconPOTUNSUS[,,"off"][,,g], dim = c(1.1, 1.2)))
  tmp  <- data.frame(Country = tmp$Region, "POT-UNSUS" = tmp$Value, GT = g)
  data <- merge(data, tmp)
  
  tmp  <- as.data.frame(dimSums(wat_ag_wwEconPOTUNSUS[,,"on"][,,g], dim = c(1.1, 1.2)))
  tmp  <- data.frame(Country = tmp$Region, "POT-WATSUS" = tmp$Value, GT = g)
  data <- merge(data, tmp)
  
  tmp  <- as.data.frame(dimSums(wat_ag_wwEconPOTSUS[,,"off"][,,g], dim = c(1.1, 1.2)))
  tmp  <- data.frame(Country = tmp$Region, "POT-LANDSUS" = tmp$Value, GT = g)
  data <- merge(data, tmp)
  
  tmp  <- as.data.frame(dimSums(wat_ag_wwEconPOTSUS[,,"on"][,,g], dim = c(1.1, 1.2)))
  tmp  <- data.frame(Country = tmp$Region, "POT-SUS" = tmp$Value, GT = g)
  data <- merge(data, tmp)
  
  if (i == 0) {
    PIWW <- data
  } else {
    PIWW <- rbind(PIWW, data)
  }
  i <- i + 1
}

PIAout  <- PIA
PIWWout <- PIWW
PIWCout <- PIWC

colnames(PIAout)  <- gsub("GT", "Yield gain threshold", colnames(PIAout))
colnames(PIWWout) <- gsub("GT", "Yield gain threshold", colnames(PIWWout))
colnames(PIWCout) <- gsub("GT", "Yield gain threshold", colnames(PIWCout))

# Write country results to csv
write.csv(x = PIAout, 
          file = paste0(outputdatapath, "PIA_bycountry_b.csv"), 
          row.names = FALSE)
write.csv(x = PIWWout, 
          file = paste0(outputdatapath, "PIWW_bycountry_b.csv"), 
          row.names = FALSE)
write.csv(x = PIWCout, 
          file = paste0(outputdatapath, "PIWC_bycountry_b.csv"),
          row.names = FALSE)
rm(PIAout, PIWWout, PIWCout)
```

We provide the global overview of technical and economic irrigation potentials 
in terms of PIA and PIWC in the form of a barplot in the main manuscript.
The table Global.csv in the SI provides the full results for all sustainability 
scenarios (NOLIM, UNSUS, WATSUS, LANDSUS, SUS) and all indicators (PIWC, PIWW, PIA)
on currently irrigated areas (IRR), current (rainfed and irrigated) cropland (CUR),
and potential cropland (POT).
We distinguish three yield gain thresholds (0, 300 and 600 USD/ha).

```{r GlobalOverviewTable, include=FALSE, echo=FALSE}

gtrange <- c(0, 300, 600)
tmp <- NULL

for (g in gtrange) {
  
  global <- data.frame(Scenario = "IRR-NOLIM", 
                       PIA = round(sum(PIA$IRR.NOLIM[PIA$GT==g])), 
                       PIWC = round(sum(PIWC$IRR.NOLIM[PIWC$GT==g])), 
                       PIWW = round(sum(PIWW$IRR.NOLIM[PIWW$GT==g])))
  global <- rbind(global, 
                  data.frame(Scenario = "IRR-UNSUS", 
                             PIA = round(sum(PIA$IRR.UNSUS[PIA$GT==g])), 
                             PIWC = round(sum(PIWC$IRR.UNSUS[PIWC$GT==g])), 
                             PIWW = round(sum(PIWW$IRR.UNSUS[PIWW$GT==g]))))
  global <- rbind(global, 
                  data.frame(Scenario = "IRR-WATSUS", 
                             PIA = round(sum(PIA$IRR.WATSUS[PIA$GT==g])), 
                             PIWC = round(sum(PIWC$IRR.WATSUS[PIWC$GT==g])), 
                             PIWW = round(sum(PIWW$IRR.WATSUS[PIWW$GT==g]))))
  global <- rbind(global, 
                  data.frame(Scenario = "IRR-LANDSUS", 
                             PIA = round(sum(PIA$IRR.LANDSUS[PIA$GT==g])), 
                             PIWC = round(sum(PIWC$IRR.LANDSUS[PIWC$GT==g])), 
                             PIWW = round(sum(PIWW$IRR.LANDSUS[PIWW$GT==g]))))
  global <- rbind(global, 
                  data.frame(Scenario = "IRR-SUS", 
                             PIA = round(sum(PIA$IRR.SUS[PIA$GT==g])), 
                             PIWC = round(sum(PIWC$IRR.SUS[PIWC$GT==g])), 
                             PIWW = round(sum(PIWW$IRR.SUS[PIWW$GT==g]))))
  global <- rbind(global, 
                  data.frame(Scenario = "CUR-NOLIM", 
                             PIA = round(sum(PIA$CUR.NOLIM[PIA$GT==g])), 
                             PIWC = round(sum(PIWC$CUR.NOLIM[PIWC$GT==g])), 
                             PIWW = round(sum(PIWW$CUR.NOLIM[PIWW$GT==g]))))
  global <- rbind(global, 
                  data.frame(Scenario = "CUR-UNSUS", 
                             PIA = round(sum(PIA$CUR.UNSUS[PIA$GT==g])), 
                             PIWC = round(sum(PIWC$CUR.UNSUS[PIWC$GT==g])), 
                             PIWW = round(sum(PIWW$CUR.UNSUS[PIWW$GT==g]))))
  global <- rbind(global, 
                  data.frame(Scenario = "CUR-WATSUS", 
                             PIA = round(sum(PIA$CUR.WATSUS[PIA$GT==g])), 
                             PIWC = round(sum(PIWC$CUR.WATSUS[PIWC$GT==g])), 
                             PIWW = round(sum(PIWW$CUR.WATSUS[PIWW$GT==g]))))
  global <- rbind(global, 
                  data.frame(Scenario = "CUR-LANDSUS", 
                             PIA = round(sum(PIA$CUR.LANDSUS[PIA$GT==g])), 
                             PIWC = round(sum(PIWC$CUR.LANDSUS[PIWC$GT==g])), 
                             PIWW = round(sum(PIWW$CUR.LANDSUS[PIWW$GT==g]))))
  global <- rbind(global, 
                  data.frame(Scenario = "CUR-SUS", 
                             PIA = round(sum(PIA$CUR.SUS[PIA$GT==g])), 
                             PIWC = round(sum(PIWC$CUR.SUS[PIWC$GT==g])), 
                             PIWW = round(sum(PIWW$CUR.SUS[PIWW$GT==g]))))
  global <- rbind(global, 
                  data.frame(Scenario = "POT-NOLIM", 
                             PIA = round(sum(PIA$POT.NOLIM[PIA$GT==g])), 
                             PIWC = round(sum(PIWC$POT.NOLIM[PIWC$GT==g])), 
                             PIWW = round(sum(PIWW$POT.NOLIM[PIWW$GT==g]))))
  global <- rbind(global, 
                  data.frame(Scenario = "POT-UNSUS", 
                             PIA = round(sum(PIA$POT.UNSUS[PIA$GT==g])), 
                             PIWC = round(sum(PIWC$POT.UNSUS[PIWC$GT==g])), 
                             PIWW = round(sum(PIWW$POT.UNSUS[PIWW$GT==g]))))
  global <- rbind(global, 
                  data.frame(Scenario = "POT-WATSUS", 
                             PIA = round(sum(PIA$POT.WATSUS[PIA$GT==g])), 
                             PIWC = round(sum(PIWC$POT.WATSUS[PIWC$GT==g])), 
                             PIWW = round(sum(PIWW$POT.WATSUS[PIWW$GT==g]))))
  global <- rbind(global, 
                  data.frame(Scenario = "POT-LANDSUS", 
                             PIA = round(sum(PIA$POT.LANDSUS[PIA$GT==g])), 
                             PIWC = round(sum(PIWC$POT.LANDSUS[PIWC$GT==g])), 
                             PIWW = round(sum(PIWW$POT.LANDSUS[PIWW$GT==g]))))
  global <- rbind(global, 
                  data.frame(Scenario = "POT-SUS", 
                             PIA = round(sum(PIA$POT.SUS[PIA$GT==g])), 
                             PIWC = round(sum(PIWC$POT.SUS[PIWC$GT==g])), 
                             PIWW = round(sum(PIWW$POT.SUS[PIWW$GT==g]))))
  
  global$gainthreshold <- g
  
  tmp <- rbind(tmp, global)

}

# Table for SI
global <- reshape(tmp, idvar = "Scenario", timevar = "gainthreshold", direction = "wide")
global <- data.frame(Scenario         = global$Scenario, 
                     PIA_0    = global$PIA.0,   PIWC_0   = global$PIWC.0,   PIWW_0   = global$PIWW.0,
                     PIA_300  = global$PIA.300, PIWC_300 = global$PIWC.300, PIWW_300 = global$PIWW.300,
                     PIA_600  = global$PIA.600, PIWC_600 = global$PIWC.600, PIWW_600 = global$PIWW.600)

write.csv(x = global, 
          file = paste0(outputdatapath, "Global", ".csv"), 
          row.names = FALSE)
```


```{r StackedBarplot, include=FALSE, echo=FALSE}

# Arrange data for graph
pia <-  data.frame(SusScen = gsub(".*-", "", tmp$Scenario), 
                   LandScen = gsub("-.*", "", tmp$Scenario), 
                   gainthreshold = as.character(tmp$gainthreshold), 
                   Value = tmp$PIA, 
                   Indicator = rep("PIA", length(tmp$gainthreshold)),
                   stringsAsFactors = FALSE)
piww <-  data.frame(SusScen = gsub(".*-", "", tmp$Scenario), 
                   LandScen = gsub("-.*", "", tmp$Scenario), 
                   gainthreshold = as.character(tmp$gainthreshold), 
                   Value = tmp$PIWW, 
                   Indicator = rep("PIWW", length(tmp$gainthreshold)),
                   stringsAsFactors = FALSE)
piwc <-  data.frame(SusScen = gsub(".*-", "", tmp$Scenario), 
                   LandScen = gsub("-.*", "", tmp$Scenario), 
                   gainthreshold = as.character(tmp$gainthreshold), 
                   Value = tmp$PIWC, 
                   Indicator = rep("PIWC", length(tmp$gainthreshold)),
                   stringsAsFactors = FALSE)

data <- rbind(pia, piww, piwc)

# Arrange data (stacked bar plot)
dataStacked <- data

i <- 1
for (g in gtrange[1:(length(gtrange)-1)]) {
  dataStacked[dataStacked$gainthreshold == as.character(g),]$Value <- dataStacked[dataStacked$gainthreshold == as.character(g),]$Value - dataStacked[dataStacked$gainthreshold == as.character(gtrange[i+1]),]$Value
  i <- i + 1
}

piaStacked  <- subset(dataStacked[dataStacked$Indicator == "PIA", ], select = c("SusScen", "LandScen", "gainthreshold", "Value"))
piaStacked  <- piaStacked[piaStacked$SusScen != "NOLIM",]
piwcStacked <- subset(dataStacked[dataStacked$Indicator == "PIWC", ], select = c("SusScen", "LandScen", "gainthreshold", "Value"))
piwcStacked <- piwcStacked[piwcStacked$SusScen != "NOLIM",]
data        <- data[data$SusScen != "NOLIM",]

PIA_IRR <- ggplot(data = piaStacked[piaStacked$LandScen == "IRR",], aes(x = SusScen, y = Value, fill = gainthreshold)) +
                  geom_bar(stat = "identity", width = 0.9) +
                  geom_text(aes(label = Value), vjust = -0.25, 
                               data = data[data$gainthreshold == 0 & data$Indicator == "PIA" & data$LandScen == "IRR", ],
                               color = "black", size = 7) +
                  scale_fill_manual(name = "Yield gain threshold (in USD/ha): ", values = c("#66c2a4", "#6a51a3", "#d94701")) +
                  scale_x_discrete(name = "", limits = piaStacked$SusScen[1:4]) +
                  theme_minimal() +
                  ggtitle("1a) PIA on IRR") + 
                  scale_y_continuous(name = "Mha", limits = c(0, 200), breaks = c(0, 50, 100, 150, 200)) + 
                  theme(legend.position = "bottom",
                        text = element_text(size = 24),
                        axis.ticks = element_blank(),
                        axis.title = element_text(size = 24),
                        plot.title = element_text(size = 20, face = "bold"),
                        axis.text.x = element_blank(),
                        axis.text.y = element_text(size = 20))

PIA_CUR <- ggplot(data = piaStacked[piaStacked$LandScen == "CUR",], aes(x = SusScen, y = Value, fill = gainthreshold)) +
                  geom_bar(stat = "identity", width = 0.9) +
                  geom_text(aes(label = Value), vjust = -0.05, 
                               data = data[data$gainthreshold == 0 & data$Indicator == "PIA" & data$LandScen == "CUR", ],
                               color = "black", size = 7) +
                  scale_fill_manual(name = "Yield gain threshold (in USD/ha): ", values = c("#66c2a4", "#6a51a3", "#d94701")) +
                  scale_x_discrete(name = "", limits = piaStacked$SusScen[1:4]) +
                  theme_minimal() +
                  ggtitle("1b) PIA on CUR") + 
                  scale_y_continuous(name = "", limits = c(0, 1200), breaks = c(0, 200, 400, 600, 800, 1000)) +
                  theme(legend.position = "bottom",
                        text = element_text(size = 24),
                        axis.ticks = element_blank(),
                        axis.title = element_text(size = 24),
                        plot.title = element_text(size = 20, face = "bold"),
                        axis.text.x = element_blank(),
                        axis.text.y = element_text(size = 20))

PIA_POT <- ggplot(data = piaStacked[piaStacked$LandScen == "POT",], aes(x = SusScen, y = Value, fill = gainthreshold)) +
                  geom_bar(stat = "identity", width = 0.9) +
                  geom_text(aes(label = Value), vjust = -0.05, 
                               data = data[data$gainthreshold == 0 & data$Indicator == "PIA" & data$LandScen == "POT", ],
                               color = "black", size = 7) +
                  scale_fill_manual(name = "Yield gain threshold (in USD/ha): ", values = c("#66c2a4", "#6a51a3", "#d94701")) +
                  scale_x_discrete(name = "", limits = piaStacked$SusScen[1:4]) +
                  theme_minimal() +
                  scale_y_continuous(name = "", limits = c(0, 3500), breaks = c(0, 1000, 2000, 3000)) +
                  ggtitle("1c) PIA on POT") +
                  theme(legend.position = "bottom",
                        text = element_text(size = 24),
                        axis.ticks = element_blank(),
                        axis.title = element_text(size = 24),
                        plot.title = element_text(size = 20, face = "bold"),
                        axis.text.x = element_blank(),
                        axis.text.y = element_text(size = 20))

PIWC_IRR <- ggplot(data = piwcStacked[piwcStacked$LandScen == "IRR",], aes(x = SusScen, y = Value, fill = gainthreshold)) +
                  geom_bar(stat = "identity", width = 0.9) +
                  geom_text(aes(label = Value), vjust = -0.25, 
                               data = data[data$gainthreshold == 0 & data$Indicator == "PIWC" & data$LandScen == "IRR", ],
                               color = "black", size = 7) +
                  scale_fill_manual(name = "Yield gain threshold (in USD/ha): ", values = c("#66c2a4", "#6a51a3", "#d94701")) +
                  scale_x_discrete(name = "", limits = piwcStacked$SusScen[1:4]) +
                  theme_minimal() +
                  ggtitle("2a) PIWC on IRR") + 
                  scale_y_continuous(name = "km3", limits = c(0, 600), breaks = c(0, 100, 200, 300, 400, 500, 600)) + 
                  theme(legend.position = "bottom",
                        text = element_text(size = 24),
                        axis.ticks = element_blank(),
                        axis.title = element_text(size = 24),
                        plot.title = element_text(size = 20, face = "bold"),
                        axis.text.x = element_text(face = "bold", size = 20, angle = 90, vjust = -0.05),
                        axis.text.y = element_text(size = 20))

PIWC_CUR <- ggplot(data = piwcStacked[piwcStacked$LandScen == "CUR",], aes(x = SusScen, y = Value, fill = gainthreshold)) +
                  geom_bar(stat = "identity", width = 0.9) +
                  geom_text(aes(label = Value), vjust = -0.05, 
                               data = data[data$gainthreshold == 0 & data$Indicator == "PIWC" & data$LandScen == "CUR", ],
                               color = "black", size = 7) +
                  scale_fill_manual(name = "Yield gain threshold (in USD/ha): ", values = c("#66c2a4", "#6a51a3", "#d94701")) +
                  scale_x_discrete(name = "", limits = piwcStacked$SusScen[1:4]) +
                  theme_minimal() +
                  ggtitle("2b) PIWC on CUR") + 
                  scale_y_continuous(name = "", limits = c(0, 2500), breaks = c(0, 500, 1000, 1500, 2000)) + 
                  theme(legend.position = "bottom",
                        text = element_text(size = 24),
                        axis.ticks = element_blank(),
                        axis.title = element_text(size = 24),
                        plot.title = element_text(size = 20, face = "bold"),
                        axis.text.x = element_text(face = "bold", size = 20, angle = 90, vjust = -0.05),
                        axis.text.y = element_text(size = 20))

PIWC_POT <- ggplot(data = piwcStacked[piwcStacked$LandScen == "POT",], aes(x = SusScen, y = Value, fill = gainthreshold)) +
                  geom_bar(stat = "identity", width = 0.9) +
                  geom_text(aes(label = Value), vjust = -0.05, 
                               data = data[data$gainthreshold == 0 & data$Indicator == "PIWC" & data$LandScen == "POT", ],
                               color = "black", size = 7) +
                  scale_fill_manual(name = "Yield gain threshold (in USD/ha): ", values = c("#66c2a4", "#6a51a3", "#d94701")) +
                  scale_x_discrete(name = "", limits = piwcStacked$SusScen[1:4]) +
                  theme_minimal() +
                  scale_y_continuous(name = "", limits = c(0, 6000), breaks = c(0, 2000, 4000, 6000)) + 
                  ggtitle("2c) PIWC on POT") +
                  theme(legend.position = "bottom",
                        text = element_text(size = 24),
                        axis.ticks = element_blank(),
                        axis.title = element_text(size = 24),
                        plot.title = element_text(size = 20, face = "bold"),
                        axis.text.x = element_text(face = "bold", size = 20, angle = 90, vjust = -0.05),
                        axis.text.y = element_text(size = 20))

barplotPIA <- ggarrange(PIA_IRR, PIA_CUR, PIA_POT, 
                     ncol = 3, common.legend = TRUE, legend = "bottom")
barplotPIWC <- ggarrange(PIWC_IRR, PIWC_CUR, PIWC_POT, 
                     ncol = 3, common.legend = TRUE, legend = "bottom")

barplotCombined <- ggarrange(PIA_IRR, PIA_CUR, PIA_POT, 
                             PIWC_IRR, PIWC_CUR, PIWC_POT, 
                             ncol = 3, nrow = 2,
                             heights = c(4, 6),
                             common.legend = TRUE, legend = "bottom")

ggsave(paste0(outputdatapath, "barplot.pdf"), plot = barplotCombined, 
       width = 297, height = 210, units = "mm")
                  
```

# PIA curves for countries and basins

```{r readinCurveData, include = FALSE, echo = FALSE}
# Available irrigation area on potential cropland
avlArea <- read.magpie(paste0(inputdatapath, "avlIrrigarea_pot.mz"))

### Read in data ###
currCroplandSUS   <- collapseNames(IrrigAreaEconCURSUS[, , "on"])
potCroplandSUS    <- collapseNames(IrrigAreaEconPOTSUS[, , "on"])
currCroplandUNSUS <- collapseNames(IrrigAreaEconCURUNSUS[, , "off"])
potCroplandUNSUS  <- collapseNames(IrrigAreaEconPOTUNSUS[, , "off"])
currYieldgain1    <- read.magpie(paste0(inputdatapath, "yieldgainarea_curUNSUS.mz"))
potYieldgain1     <- read.magpie(paste0(inputdatapath, "yieldgainarea_potUNSUS.mz"))

```

```{r PIAcurveFunctionFull, include=TRUE, echo=FALSE}

plotIADcurve <- function(version     = "HalfEarth",
                         aggregation = "countries",
                         range       = c(0, 1000)) {
  
  yscale <- getNames(currCroplandSUS)[as.numeric(getNames(currCroplandSUS)) >= min(range) &
                                      as.numeric(getNames(currCroplandSUS)) <= max(range)]

  ### Aggregate and rearrange data ###
  if (aggregation == "countries") {

    df   <- as.data.frame(dimSums(currCroplandSUS[, , yscale], dim = c(1.1, 1.2)))
    df$IrrigArea <- "Sustainable \nPotentially Irrigated Areas \non current cropland \n(CUR-SUS)"
    
    tmp    <- as.data.frame(dimSums(currCroplandUNSUS[, , yscale], dim = c(1.1, 1.2)))
    tmp$IrrigArea <- "Potentially Irrigated Areas \non current cropland \n(CUR-UNSUS)"
    df <- rbind(df, tmp)
    
    tmp    <- as.data.frame(dimSums(yieldgainareaCURunsus[, , yscale], dim = c(1.1, 1.2)))
    tmp$IrrigArea <- "Yield gain areas \non current cropland \n(CUR-NOLIM)"
    df <- rbind(df, tmp)

    tmp    <- as.data.frame(dimSums(potCroplandSUS[, , yscale], dim = c(1.1, 1.2)))
    tmp$IrrigArea <- "Sustainable \nPotentially Irrigated Areas \non potential cropland \n(POT-SUS)"
    df <- rbind(df, tmp)

    df <- data.frame(Region = df$Region,
                     GT = as.numeric(as.character(df$Data1)),
                     Group = df$IrrigArea,
                     IrrigArea = df$Value,
                     stringsAsFactors = FALSE)
    df$LUHIrrigated <- rep(as.array(dimSums(LUHirrigated, dim = c(1.1, 1.2))), length(df$Group) /
                             length(as.array(dimSums(LUHirrigated, dim = c(1.1, 1.2)))))
    df$LUHCropland  <- rep(as.array(dimSums(LUHtotal, dim = c(1.1, 1.2))), length(df$Group) / 
                             length(as.array(dimSums(LUHtotal, dim = c(1.1, 1.2)))))

    df        <- df[df$Region %in%          c("CHN", "IND", "AUS", "USA", "MEX", "BRA", "ITA", "TUR", "SDN"), ]
    df$Region <- factor(df$Region, levels = c("CHN", "IND", "AUS", "USA", "MEX", "BRA", "ITA", "TUR", "SDN"))
    
  } else if (aggregation == "basins") {

    selectedBasins <- c("Chang Jiang", "Huang He", "Mekong",
                        "Mississippi", "Colorado", "Murray",
                        "Parana", "Ganges", "Indus")

    framestructure <- as.data.frame(new.magpie(cells_and_regions = selectedBasins,
                                               years = getYears(currCroplandSUS),
                                               names = yscale))
    df             <- framestructure
    for (b in selectedBasins) {
      df$Value[df$Region == b] <- dimSums(currCroplandSUS[toolSelectRiverBasin(basinname = b), , yscale], dim = 1)
    }
    df$Group <- "Sustainable \nPotentially Irrigated Areas \non current cropland \n(CUR-SUS)"
    
    tmp <- framestructure
    for (b in selectedBasins) {
      tmp$Value[tmp$Region == b] <- dimSums(currCroplandUNSUS[toolSelectRiverBasin(basinname = b), , yscale], dim = 1)
    }
    tmp$Group <- "Potentially Irrigated Areas \non current cropland \n(CUR-UNSUS)"
    df <- rbind(df, tmp)
    
    tmp <- framestructure
    for (b in selectedBasins) {
      tmp$Value[tmp$Region == b] <- dimSums(yieldgainareaCURunsus[toolSelectRiverBasin(basinname = b), , yscale], dim = 1)
    }
    tmp$Group <- "Yield gain \nareas \non current cropland \n(CUR-NOLIM)"
    df <- rbind(df, tmp)    

    tmp <- framestructure
    for (b in selectedBasins) {
      tmp$Value[tmp$Region == b] <- dimSums(potCroplandSUS[toolSelectRiverBasin(basinname = b), , yscale], dim = 1)
    }
    tmp$Group <- "Sustainable \nPotentially Irrigated Areas \non potential cropland \n(POT-SUS)"
    df <- rbind(df, tmp)

    df <- data.frame(Region = df$Region,
                     GT = as.numeric(as.character(df$Data1)),
                     Group = df$Group,
                     IrrigArea = df$Value,
                     stringsAsFactors = FALSE)

    tmp <- framestructure
    for (b in selectedBasins) {
      tmp$Value[tmp$Region == b] <- dimSums(LUHirrigated[toolSelectRiverBasin(basinname = b), , ], dim = 1)
      tmp$Value1[tmp$Region == b] <- dimSums(LUHtotal[toolSelectRiverBasin(basinname = b), , ], dim = 1)
    }
    df$LUHIrrigated <- tmp$Value
    df$LUHCropland  <- tmp$Value1
    df$Region <- factor(df$Region, levels = selectedBasins)

  } else {
    stop("Chosen aggregation is not yet implemented")
  }

  if (aggregation == "basins") {
    panel <- "(A) "
  } else {
    panel <- "(B) "
  }
  
  ### Plot ###
  out <- ggplot(df, aes(x = IrrigArea, y = GT, color = Group, group = Group, shape = Group)) +
                geom_line(aes(linetype = Group), size = 1.5) +
                geom_point(aes(shape = Group), size = 3) +
                geom_point(aes(x = LUHIrrigated, y = 0), size = 5, color = "black", shape = 17) +
                facet_wrap(~Region, scales = "free_x") +
                # scale order:                   CUR-UNSUS   CUR-SUS,  POT-SUS      CUR-NOLIM
                scale_color_manual(values =    c("#80cdc1", "#01665e", "#543005",  "#bf812d")) +
                scale_linetype_manual(values = c("solid",   "solid",   "solid",    "dashed")) +
                scale_shape_manual(values =    c(13,         19,       19,         23)) +
                scale_x_continuous(name = "Potentially Irrigated Areas (in Mha)", expand = c(0, 0), limits = c(0,NA)) +
                scale_y_continuous(name = "Irrigation yield gain (in USD/ha)", expand = c(0, 0), limits = c(0, 1000), breaks = c(0, 300, 600, 900)) +
                ggtitle(paste0(panel, "PIA curves for selected ", aggregation)) +
                theme_bw() +
                theme(legend.title         = element_blank(),
                      legend.position      = "bottom",
                      legend.text          = element_text(size = 14),
                      legend.key.width     = unit(2.8, "line"),
                      legend.justification = c(0, 1),
                      legend.margin        = margin(t = 0, r = 0, b = 0, l = 0, unit = "pt"),
                      strip.text           = element_text(size = 18),
                      strip.background     = element_rect(fill = "#f6f6f6"),
                      plot.title           = element_text(size = 20, face = "bold"),
                      axis.text.x          = element_text(size = 16),
                      axis.title.x         = element_text(size = 18),
                      axis.text.y          = element_text(size = 16),
                      axis.title.y         = element_text(size = 18),
                      panel.grid.major.x   = element_blank(),
                      panel.grid.minor.x   = element_blank())
  ggsave(paste0(outputdatapath, aggregation, "_Curves.pdf"), plot = out, width = 297, height = 210, units = "mm")
  
  return(out)
}

```



```{r PlotAggregateFull, include=FALSE, echo=FALSE}

plotCountries <- plotIADcurve(version = version, aggregation = "countries", range = c(0, 1000))
plotBasins    <- plotIADcurve(version = version, aggregation = "basins", range = c(0, 1000))

combinedPlot <- ggarrange(plotBasins, ggplot() + theme_void(), plotCountries, 
                          heights = c(1, 0.05, 1),
                          ncol = 1, nrow = 3, common.legend = TRUE, legend = "bottom")

ggsave(paste0(outputdatapath, "combined_Curves.pdf"), plot = combinedPlot, 
       width = 297, height = 420, units = "mm")

```



## Global Irrigation Potentials

When analyzing irrigation potentials of current or historic time periods, 
the current agricultural use reservation option should be included
because current human water abstractions for irrigated agriculture divert 
river flows and should be considered in the assessment of cellular discharge.

The following section used a model run where the current agricultural use 
river routing iteration is activated.
It is the basis for the global summary table, the irrigation potential maps and
additional country tables of the Supplementary Material labeled with (a). 


```{r SCENARIOdataCOMAG, include=FALSE, echo=FALSE}
# Current irrigated area (ACTUAL)
IrrigAreaEconIRRSUScomAg   <- read.magpie(paste0(inputdatapath, "IrrigAreaEconACTSUScomAg", ".mz"))
IrrigAreaEconIRRUNSUScomAg <- read.magpie(paste0(inputdatapath, "IrrigAreaEconACTUNSUScomAg", ".mz"))

wat_ag_wcEconIRRSUScomAg   <- read.magpie(paste0(inputdatapath, "wat_ag_wcEconACTSUScomAg", ".mz"))
wat_ag_wcEconIRRUNSUScomAg <- read.magpie(paste0(inputdatapath, "wat_ag_wcEconACTUNSUScomAg", ".mz"))

wat_ag_wwEconIRRSUScomAg   <- read.magpie(paste0(inputdatapath, "wat_ag_wwEconACTSUScomAg", ".mz"))
wat_ag_wwEconIRRUNSUScomAg <- read.magpie(paste0(inputdatapath, "wat_ag_wwEconACTUNSUScomAg", ".mz"))

# Current cropland area (CUR)
IrrigAreaEconCURSUScomAg   <- read.magpie(paste0(inputdatapath, "IrrigAreaEconCURSUScomAg", ".mz"))
IrrigAreaEconCURUNSUScomAg <- read.magpie(paste0(inputdatapath, "IrrigAreaEconCURUNSUScomAg", ".mz"))

wat_ag_wcEconCURSUScomAg   <- read.magpie(paste0(inputdatapath, "wat_ag_wcEconCURSUScomAg", ".mz"))
wat_ag_wcEconCURUNSUScomAg <- read.magpie(paste0(inputdatapath, "wat_ag_wcEconCURUNSUScomAg", ".mz"))

wat_ag_wwEconCURSUScomAg   <- read.magpie(paste0(inputdatapath, "wat_ag_wwEconCURSUScomAg", ".mz"))
wat_ag_wwEconCURUNSUScomAg <- read.magpie(paste0(inputdatapath, "wat_ag_wwEconCURUNSUScomAg", ".mz"))

# Potential cropland area (POT)
IrrigAreaEconPOTSUScomAg   <- read.magpie(paste0(inputdatapath, "IrrigAreaEconPOTSUScomAg", ".mz"))
IrrigAreaEconPOTUNSUScomAg <- read.magpie(paste0(inputdatapath, "IrrigAreaEconPOTUNSUScomAg", ".mz"))

wat_ag_wcEconPOTSUScomAg   <- read.magpie(paste0(inputdatapath, "wat_ag_wcEconPOTSUScomAg", ".mz"))
wat_ag_wcEconPOTUNSUScomAg <- read.magpie(paste0(inputdatapath, "wat_ag_wcEconPOTUNSUScomAg", ".mz"))

wat_ag_wwEconPOTSUScomAg   <- read.magpie(paste0(inputdatapath, "wat_ag_wwEconPOTSUScomAg", ".mz"))
wat_ag_wwEconPOTUNSUScomAg <- read.magpie(paste0(inputdatapath, "wat_ag_wwEconPOTUNSUScomAg", ".mz"))

```

```{r OverviewTablesCOMAG, include=FALSE, echo=FALSE}
# Extract reported yield gain thresholds
gt <- getNames(collapseNames(IrrigAreaEconIRRSUScomAg[,,"on"]))

## Irrigated Area (PIA = Potentially Irrigated Areas) [mio. ha]
i <- 0

for (g in gt) {

  # Actually Irrigated Land
  data <- as.data.frame(dimSums(yieldgainareaIRRunsus[,,g], dim = c(1.1, 1.2)))
  data <- data.frame(Country = data$Region, "IRR-NOLIM" = data$Value, GT = g)
  
  tmp  <- as.data.frame(dimSums(IrrigAreaEconIRRUNSUScomAg[,,"off"][,,"0"], dim = c(1.1, 1.2)))
  tmp  <- data.frame(Country = tmp$Region, "IRR-UNSUS" = tmp$Value, GT = g)
  data <- merge(data, tmp)
  
  tmp  <- as.data.frame(dimSums(IrrigAreaEconIRRUNSUScomAg[,,"on"][,,g], dim = c(1.1, 1.2)))
  tmp  <- data.frame(Country = tmp$Region, "IRR-WATSUS" = tmp$Value, GT = g)
  data <- merge(data, tmp)
  
  tmp  <- as.data.frame(dimSums(IrrigAreaEconIRRSUScomAg[,,"off"][,,g], dim = c(1.1, 1.2)))
  tmp  <- data.frame(Country = tmp$Region, "IRR-LANDSUS" = tmp$Value, GT = g)
  data <- merge(data, tmp)
  
  tmp  <- as.data.frame(dimSums(IrrigAreaEconIRRSUScomAg[,,"on"][,,g], dim = c(1.1, 1.2)))
  tmp  <- data.frame(Country = tmp$Region, "IRR-SUS" = tmp$Value, GT = g)
  data <- merge(data, tmp)
  
  # Current Cropland
  tmp  <- as.data.frame(dimSums(yieldgainareaCURunsus[,,g], dim = c(1.1, 1.2)))
  tmp  <- data.frame(Country = tmp$Region, "CUR-NOLIM" = tmp$Value, GT = g)
  data <- merge(data, tmp)
  
  tmp  <- as.data.frame(dimSums(IrrigAreaEconCURUNSUScomAg[,,"off"][,,g], dim = c(1.1, 1.2)))
  tmp  <- data.frame(Country = tmp$Region, "CUR-UNSUS" = tmp$Value, GT = g)
  data <- merge(data, tmp)
  
  tmp  <- as.data.frame(dimSums(IrrigAreaEconCURUNSUScomAg[,,"on"][,,g], dim = c(1.1, 1.2)))
  tmp  <- data.frame(Country = tmp$Region, "CUR-WATSUS" = tmp$Value, GT = g)
  data <- merge(data, tmp)
  
  tmp  <- as.data.frame(dimSums(IrrigAreaEconCURSUScomAg[,,"off"][,,g], dim = c(1.1, 1.2)))
  tmp  <- data.frame(Country = tmp$Region, "CUR-LANDSUS" = tmp$Value, GT = g)
  data <- merge(data, tmp)
  
  tmp  <- as.data.frame(dimSums(IrrigAreaEconCURSUScomAg[,,"on"][,,g], dim = c(1.1, 1.2)))
  tmp  <- data.frame(Country = tmp$Region, "CUR-SUS" = tmp$Value, GT = g)
  data <- merge(data, tmp)
  
  # Potential cropland
  tmp  <- as.data.frame(dimSums(yieldgainareaPOTunsus[,,g], dim = c(1.1, 1.2)))
  tmp  <- data.frame(Country = tmp$Region, "POT-NOLIM" = tmp$Value, GT = g)
  data <- merge(data, tmp)
  
  tmp  <- as.data.frame(dimSums(IrrigAreaEconPOTUNSUScomAg[,,"off"][,,g], dim = c(1.1, 1.2)))
  tmp  <- data.frame(Country = tmp$Region, "POT-UNSUS" = tmp$Value, GT = g)
  data <- merge(data, tmp)
  
  tmp  <- as.data.frame(dimSums(IrrigAreaEconPOTUNSUScomAg[,,"on"][,,g], dim = c(1.1, 1.2)))
  tmp  <- data.frame(Country = tmp$Region, "POT-WATSUS" = tmp$Value, GT = g)
  data <- merge(data, tmp)
  
  tmp  <- as.data.frame(dimSums(IrrigAreaEconPOTSUScomAg[,,"off"][,,g], dim = c(1.1, 1.2)))
  tmp  <- data.frame(Country = tmp$Region, "POT-LANDSUS" = tmp$Value, GT = g)
  data <- merge(data, tmp)
  
  tmp  <- as.data.frame(dimSums(IrrigAreaEconPOTSUScomAg[,,"on"][,,g], dim = c(1.1, 1.2)))
  tmp  <- data.frame(Country = tmp$Region, "POT-SUS" = tmp$Value, GT = g)
  data <- merge(data, tmp)
  
  if (i == 0) {
    PIA <- data
  } else {
    PIA <- rbind(PIA, data)
  }
  i <- i + 1
}

## Irrigated Water Consumption (PIWC = Irrigation Water Consumption Potentials) [mio. km^3]
i <- 0

for (g in gt) {

  # Actually Irrigated Land
  data <- as.data.frame(dimSums(yieldgainwaterIRRunsus[,,"consumption"][,,g], dim = c(1.1, 1.2)))
  data <- data.frame(Country = data$Region, "IRR-NOLIM" = data$Value, GT = g)
  
  tmp  <- as.data.frame(dimSums(wat_ag_wcEconIRRUNSUScomAg[,,"off"][,,"0"], dim = c(1.1, 1.2)))
  tmp  <- data.frame(Country = tmp$Region, "IRR-UNSUS" = tmp$Value, GT = g)
  data <- merge(data, tmp)
  
  tmp  <- as.data.frame(dimSums(wat_ag_wcEconIRRUNSUScomAg[,,"on"][,,g], dim = c(1.1, 1.2)))
  tmp  <- data.frame(Country = tmp$Region, "IRR-WATSUS" = tmp$Value, GT = g)
  data <- merge(data, tmp)
  
  tmp  <- as.data.frame(dimSums(wat_ag_wcEconIRRSUScomAg[,,"off"][,,g], dim = c(1.1, 1.2)))
  tmp  <- data.frame(Country = tmp$Region, "IRR-LANDSUS" = tmp$Value, GT = g)
  data <- merge(data, tmp)
  
  tmp  <- as.data.frame(dimSums(wat_ag_wcEconIRRSUScomAg[,,"on"][,,g], dim = c(1.1, 1.2)))
  tmp  <- data.frame(Country = tmp$Region, "IRR-SUS" = tmp$Value, GT = g)
  data <- merge(data, tmp)
  
  # Current Cropland
  tmp  <- as.data.frame(dimSums(yieldgainwaterCURunsus[,,"consumption"][,,g], dim = c(1.1, 1.2)))
  tmp  <- data.frame(Country = tmp$Region, "CUR-NOLIM" = tmp$Value, GT = g)
  data <- merge(data, tmp)
  
  tmp  <- as.data.frame(dimSums(wat_ag_wcEconCURUNSUScomAg[,,"off"][,,g], dim = c(1.1, 1.2)))
  tmp  <- data.frame(Country = tmp$Region, "CUR-UNSUS" = tmp$Value, GT = g)
  data <- merge(data, tmp)
  
  tmp  <- as.data.frame(dimSums(wat_ag_wcEconCURUNSUScomAg[,,"on"][,,g], dim = c(1.1, 1.2)))
  tmp  <- data.frame(Country = tmp$Region, "CUR-WATSUS" = tmp$Value, GT = g)
  data <- merge(data, tmp)
  
  tmp  <- as.data.frame(dimSums(wat_ag_wcEconCURSUScomAg[,,"off"][,,g], dim = c(1.1, 1.2)))
  tmp  <- data.frame(Country = tmp$Region, "CUR-LANDSUS" = tmp$Value, GT = g)
  data <- merge(data, tmp)
  
  tmp  <- as.data.frame(dimSums(wat_ag_wcEconCURSUScomAg[,,"on"][,,g], dim = c(1.1, 1.2)))
  tmp  <- data.frame(Country = tmp$Region, "CUR-SUS" = tmp$Value, GT = g)
  data <- merge(data, tmp)
  
  # Potential cropland
  tmp  <- as.data.frame(dimSums(yieldgainwaterPOTunsus[,,"consumption"][,,g], dim = c(1.1, 1.2)))
  tmp  <- data.frame(Country = tmp$Region, "POT-NOLIM" = tmp$Value, GT = g)
  data <- merge(data, tmp)
  
  tmp  <- as.data.frame(dimSums(wat_ag_wcEconPOTUNSUScomAg[,,"off"][,,g], dim = c(1.1, 1.2)))
  tmp  <- data.frame(Country = tmp$Region, "POT-UNSUS" = tmp$Value, GT = g)
  data <- merge(data, tmp)
  
  tmp  <- as.data.frame(dimSums(wat_ag_wcEconPOTUNSUScomAg[,,"on"][,,g], dim = c(1.1, 1.2)))
  tmp  <- data.frame(Country = tmp$Region, "POT-WATSUS" = tmp$Value, GT = g)
  data <- merge(data, tmp)
  
  tmp  <- as.data.frame(dimSums(wat_ag_wcEconPOTSUScomAg[,,"off"][,,g], dim = c(1.1, 1.2)))
  tmp  <- data.frame(Country = tmp$Region, "POT-LANDSUS" = tmp$Value, GT = g)
  data <- merge(data, tmp)
  
  tmp  <- as.data.frame(dimSums(wat_ag_wcEconPOTSUScomAg[,,"on"][,,g], dim = c(1.1, 1.2)))
  tmp  <- data.frame(Country = tmp$Region, "POT-SUS" = tmp$Value, GT = g)
  data <- merge(data, tmp)
  
  if (i == 0) {
    PIWC <- data
  } else {
    PIWC <- rbind(PIWC, data)
  }
  i <- i + 1
}



## Irrigated Water Withdrawals (PIWW = Irrigation Water Withdrawal Potentials) [mio. km^3]
i <- 0

for (g in gt) {

  # Actually Irrigated Land
  data <- as.data.frame(dimSums(yieldgainwaterIRRunsus[,,"withdrawal"][,,g], dim = c(1.1, 1.2)))
  data <- data.frame(Country = data$Region, "IRR-NOLIM" = data$Value, GT = g)
  
  tmp  <- as.data.frame(dimSums(wat_ag_wwEconIRRUNSUScomAg[,,"off"][,,"0"], dim = c(1.1, 1.2)))
  tmp  <- data.frame(Country = tmp$Region, "IRR-UNSUS" = tmp$Value, GT = g)
  data <- merge(data, tmp)
  
  tmp  <- as.data.frame(dimSums(wat_ag_wwEconIRRUNSUScomAg[,,"on"][,,g], dim = c(1.1, 1.2)))
  tmp  <- data.frame(Country = tmp$Region, "IRR-WATSUS" = tmp$Value, GT = g)
  data <- merge(data, tmp)
  
  tmp  <- as.data.frame(dimSums(wat_ag_wwEconIRRSUScomAg[,,"off"][,,g], dim = c(1.1, 1.2)))
  tmp  <- data.frame(Country = tmp$Region, "IRR-LANDSUS" = tmp$Value, GT = g)
  data <- merge(data, tmp)
  
  tmp  <- as.data.frame(dimSums(wat_ag_wwEconIRRSUScomAg[,,"on"][,,g], dim = c(1.1, 1.2)))
  tmp  <- data.frame(Country = tmp$Region, "IRR-SUS" = tmp$Value, GT = g)
  data <- merge(data, tmp)
  
  # Current Cropland
  tmp  <- as.data.frame(dimSums(yieldgainwaterCURunsus[,,"withdrawal"][,,g], dim = c(1.1, 1.2)))
  tmp  <- data.frame(Country = tmp$Region, "CUR-NOLIM" = tmp$Value, GT = g)
  data <- merge(data, tmp)
  
  tmp  <- as.data.frame(dimSums(wat_ag_wwEconCURUNSUScomAg[,,"off"][,,g], dim = c(1.1, 1.2)))
  tmp  <- data.frame(Country = tmp$Region, "CUR-UNSUS" = tmp$Value, GT = g)
  data <- merge(data, tmp)
  
  tmp  <- as.data.frame(dimSums(wat_ag_wwEconCURUNSUScomAg[,,"on"][,,g], dim = c(1.1, 1.2)))
  tmp  <- data.frame(Country = tmp$Region, "CUR-WATSUS" = tmp$Value, GT = g)
  data <- merge(data, tmp)
  
  tmp  <- as.data.frame(dimSums(wat_ag_wwEconCURSUScomAg[,,"off"][,,g], dim = c(1.1, 1.2)))
  tmp  <- data.frame(Country = tmp$Region, "CUR-LANDSUS" = tmp$Value, GT = g)
  data <- merge(data, tmp)
  
  tmp  <- as.data.frame(dimSums(wat_ag_wwEconCURSUScomAg[,,"on"][,,g], dim = c(1.1, 1.2)))
  tmp  <- data.frame(Country = tmp$Region, "CUR-SUS" = tmp$Value, GT = g)
  data <- merge(data, tmp)
  
  # Potential cropland
  tmp  <- as.data.frame(dimSums(yieldgainwaterPOTunsus[,,"withdrawal"][,,g], dim = c(1.1, 1.2)))
  tmp  <- data.frame(Country = tmp$Region, "POT-NOLIM" = tmp$Value, GT = g)
  data <- merge(data, tmp)
  
  tmp  <- as.data.frame(dimSums(wat_ag_wwEconPOTUNSUScomAg[,,"off"][,,g], dim = c(1.1, 1.2)))
  tmp  <- data.frame(Country = tmp$Region, "POT-UNSUS" = tmp$Value, GT = g)
  data <- merge(data, tmp)
  
  tmp  <- as.data.frame(dimSums(wat_ag_wwEconPOTUNSUScomAg[,,"on"][,,g], dim = c(1.1, 1.2)))
  tmp  <- data.frame(Country = tmp$Region, "POT-WATSUS" = tmp$Value, GT = g)
  data <- merge(data, tmp)
  
  tmp  <- as.data.frame(dimSums(wat_ag_wwEconPOTSUScomAg[,,"off"][,,g], dim = c(1.1, 1.2)))
  tmp  <- data.frame(Country = tmp$Region, "POT-LANDSUS" = tmp$Value, GT = g)
  data <- merge(data, tmp)
  
  tmp  <- as.data.frame(dimSums(wat_ag_wwEconPOTSUScomAg[,,"on"][,,g], dim = c(1.1, 1.2)))
  tmp  <- data.frame(Country = tmp$Region, "POT-SUS" = tmp$Value, GT = g)
  data <- merge(data, tmp)
  
  if (i == 0) {
    PIWW <- data
  } else {
    PIWW <- rbind(PIWW, data)
  }
  i <- i + 1
}

PIAout  <- PIA
PIWWout <- PIWW
PIWCout <- PIWC

colnames(PIAout)  <- gsub("GT", "Yield gain threshold", colnames(PIAout))
colnames(PIWWout) <- gsub("GT", "Yield gain threshold", colnames(PIWWout))
colnames(PIWCout) <- gsub("GT", "Yield gain threshold", colnames(PIWCout))

# Write country results to csv
write.csv(x = PIAout, 
          file = paste0(outputdatapath, "PIA_bycountry_a.csv"), 
          row.names = FALSE)
write.csv(x = PIWWout, 
          file = paste0(outputdatapath, "PIWW_bycountry_a.csv"), 
          row.names = FALSE)
write.csv(x = PIWCout, 
          file = paste0(outputdatapath, "PIWC_bycountry_a.csv"),
          row.names = FALSE)
rm(PIAout, PIWWout, PIWCout)

```

```{r GlobalOverviewTablecomAg, include=FALSE, echo=FALSE}

tmp <- NULL
for (g in c(0, 300, 600)) {
  
  global <- data.frame(Scenario = "IRR-NOLIM", 
                       PIA = round(sum(PIA$IRR[PIA$GT==g])), 
                       PIWC = round(sum(PIWC$IRR[PIWC$GT==g])), 
                       PIWW = round(sum(PIWW$IRR[PIWW$GT==g])))
  global <- rbind(global, 
                  data.frame(Scenario = "IRR-UNSUS", 
                             PIA = round(sum(PIA$IRR.UNSUS[PIA$GT==g])), 
                             PIWC = round(sum(PIWC$IRR.UNSUS[PIWC$GT==g])), 
                             PIWW = round(sum(PIWW$IRR.UNSUS[PIWW$GT==g]))))
  global <- rbind(global, 
                  data.frame(Scenario = "IRR-WATSUS", 
                             PIA = round(sum(PIA$IRR.WATSUS[PIA$GT==g])), 
                             PIWC = round(sum(PIWC$IRR.WATSUS[PIWC$GT==g])), 
                             PIWW = round(sum(PIWW$IRR.WATSUS[PIWW$GT==g]))))
  global <- rbind(global, 
                  data.frame(Scenario = "IRR-LANDSUS", 
                             PIA = round(sum(PIA$IRR.LANDSUS[PIA$GT==g])), 
                             PIWC = round(sum(PIWC$IRR.LANDSUS[PIWC$GT==g])), 
                             PIWW = round(sum(PIWW$IRR.LANDSUS[PIWW$GT==g]))))
  global <- rbind(global, 
                  data.frame(Scenario = "IRR-SUS", 
                             PIA = round(sum(PIA$IRR.SUS[PIA$GT==g])), 
                             PIWC = round(sum(PIWC$IRR.SUS[PIWC$GT==g])), 
                             PIWW = round(sum(PIWW$IRR.SUS[PIWW$GT==g]))))
  global <- rbind(global, 
                  data.frame(Scenario = "CUR-NOLIM", 
                             PIA = round(sum(PIA$CUR[PIA$GT==g])), 
                             PIWC = round(sum(PIWC$CUR[PIWC$GT==g])), 
                             PIWW = round(sum(PIWW$CUR[PIWW$GT==g]))))
  global <- rbind(global, 
                  data.frame(Scenario = "CUR-UNSUS", 
                             PIA = round(sum(PIA$CUR.UNSUS[PIA$GT==g])), 
                             PIWC = round(sum(PIWC$CUR.UNSUS[PIWC$GT==g])), 
                             PIWW = round(sum(PIWW$CUR.UNSUS[PIWW$GT==g]))))
  global <- rbind(global, 
                  data.frame(Scenario = "CUR-WATSUS", 
                             PIA = round(sum(PIA$CUR.WATSUS[PIA$GT==g])), 
                             PIWC = round(sum(PIWC$CUR.WATSUS[PIWC$GT==g])), 
                             PIWW = round(sum(PIWW$CUR.WATSUS[PIWW$GT==g]))))
  global <- rbind(global, 
                  data.frame(Scenario = "CUR-LANDSUS", 
                             PIA = round(sum(PIA$CUR.LANDSUS[PIA$GT==g])), 
                             PIWC = round(sum(PIWC$CUR.LANDSUS[PIWC$GT==g])), 
                             PIWW = round(sum(PIWW$CUR.LANDSUS[PIWW$GT==g]))))
  global <- rbind(global, 
                  data.frame(Scenario = "CUR-SUS", 
                             PIA = round(sum(PIA$CUR.SUS[PIA$GT==g])), 
                             PIWC = round(sum(PIWC$CUR.SUS[PIWC$GT==g])), 
                             PIWW = round(sum(PIWW$CUR.SUS[PIWW$GT==g]))))
  global <- rbind(global, 
                  data.frame(Scenario = "POT-NOLIM", 
                             PIA = round(sum(PIA$POT[PIA$GT==g])), 
                             PIWC = round(sum(PIWC$POT[PIWC$GT==g])), 
                             PIWW = round(sum(PIWW$POT[PIWW$GT==g]))))
  global <- rbind(global, 
                  data.frame(Scenario = "POT-UNSUS", 
                             PIA = round(sum(PIA$POT.UNSUS[PIA$GT==g])), 
                             PIWC = round(sum(PIWC$POT.UNSUS[PIWC$GT==g])), 
                             PIWW = round(sum(PIWW$POT.UNSUS[PIWW$GT==g]))))
  global <- rbind(global, 
                  data.frame(Scenario = "POT-WATSUS", 
                             PIA = round(sum(PIA$POT.WATSUS[PIA$GT==g])), 
                             PIWC = round(sum(PIWC$POT.WATSUS[PIWC$GT==g])), 
                             PIWW = round(sum(PIWW$POT.WATSUS[PIWW$GT==g]))))
  global <- rbind(global, 
                  data.frame(Scenario = "POT-LANDSUS", 
                             PIA = round(sum(PIA$POT.LANDSUS[PIA$GT==g])), 
                             PIWC = round(sum(PIWC$POT.LANDSUS[PIWC$GT==g])), 
                             PIWW = round(sum(PIWW$POT.LANDSUS[PIWW$GT==g]))))
  global <- rbind(global, 
                  data.frame(Scenario = "POT-SUS", 
                             PIA = round(sum(PIA$POT.SUS[PIA$GT==g])), 
                             PIWC = round(sum(PIWC$POT.SUS[PIWC$GT==g])), 
                             PIWW = round(sum(PIWW$POT.SUS[PIWW$GT==g]))))
  
  global$gainthreshold <- g
  
  tmp <- rbind(tmp, global)

}

global <- reshape(tmp, idvar = "Scenario", timevar = "gainthreshold", direction = "wide")

write.csv(x = global, 
          file =  paste0(outputdatapath, "Global_comAg", ".csv"), 
          row.names = FALSE)

```


## Maps

The following section creates the maps using the Equal Earth projection
to provide an equal area visualization.  

```{r LandMaskTerra, include=FALSE}
# Standard projection of MAgPIE object
LatLonProj <- "+proj=longlat +datum=WGS84"
# Equal Earth projection
NewProj    <- "+proj=eqearth +lon_0=0 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs"
# Map extent
ylim       <- c(-6500000, 8300000)
xlim       <- c(-12577316, 15581284)

### Handle vector data (country shape file and land mask) with terra package ###
# Country borders from Natural Earth Data (http://www.naturalearthdata.com/downloads/10m-cultural-vectors/). accessed on Dec. 13th 2021
worldCountries <- terra::vect(paste0(filepath, "ne_10m_admin_0_countries.shp"))
worldCountries <- terra::project(worldCountries, NewProj)

# Create land mask for pretty continent borders
landMask       <- terra::as.polygons(ext(worldCountries))
landMask       <- terra::symdif(landMask, worldCountries)

# Note: terra cannot transform raster object to Equal-Earth projection yet
.toolRasterTransform <- function(x) {
  
  x0  <- as.RasterBrick(x)
  out <- raster::projectRaster(x0, crs = crs(NewProj), over = TRUE)

  return(out)
}
```

For visualization purposes, areas with very little cropland area 
(cropland < 1 percent of cell area) are excluded from maps showing current areas.
For maps showing potential cropland areas, 
areas with potential irrigation area < 1 percent of the cell area are excluded. 

```{r ExclusionOfSmallAreas, include=FALSE, echo=FALSE}

mapping            <- toolGetMapping("LPJ_CellBelongingsToCountries.csv", type = "cell")
cellarea           <- (111e3 * 0.5) * (111e3 * 0.5) * cos(mapping$lat / 180 * pi) / 10000000000 # square meter -> Mha (1ha = 10000m^2)
cellarea           <- as.magpie(cellarea, spatial = 1)
magclass::getCells(cellarea) <- magclass::getCells(LUHtotal)

# share of cropland of total cell area
croplandcellshare <- LUHtotal / cellarea

# share potentially irrigated of total cell area
irrigcellshare    <- avlArea / cellarea

```

# Current Irrigation

The Fulfilled-Share-Map shows the share of current irrigation water demand under 
full irrigation requirements (IRR-NOLIM) 
that can be fulfilled by locally available renewable water resources 
captured in our data set (IRR-UNSUS). 

```{r ReadInCurrent, include=FALSE, echo=FALSE}
# Input data
input <- "shrCurrIrrigFulfilled"

# Read in data
x <- collapseNames(read.magpie(paste0(inputdatapath, input, ".mz"))[, year, "off.ssp2"])

# Exclude very small cropland areas
x[croplandcellshare < 0.01] <- NA

# Transform to raster for plotting
x1 <- .toolRasterTransform(x)

# Plot settings
legendcolor  <- c("#7f0000", "#b30000", "#d7301f", "#ef6548", "#fc8d59",
                  "#fdbb84", "#fdd49e", "#fee8c8", "#fff7ec", "#045a8d")
colNA        <- "#d9d9d9"
legendlimit  <- c(0, 1)
legendbreaks <- seq(0, 1, 0.1)


# Plot and save
pdf(paste0(outputdatapath, input, ".pdf"), width = 26, height = 15)

  # Main plot
  plot(landMask, col = "white", border = "white", ylim = ylim, xlim = xlim, asp = NA, axes = FALSE)
  plot(x1, border = "white", ylim = ylim, xlim = xlim,  asp = NA, axes = FALSE, 
       legend = FALSE,
       col = legendcolor,
       colNA = colNA,
       breaks = legendbreaks,
       add = T)
  plot(landMask, col = "white", border = "white", ylim = ylim, xlim = xlim,  asp = NA, axes = FALSE, add = T)
  plot(worldCountries, ylim = ylim, xlim = xlim,  asp = NA, axes = FALSE, add = T)
  
  # Legend
    plot(x1,
       legend.only   = TRUE,
       horizontal    = TRUE,
       col           = legendcolor,
       breaks        = legendbreaks,
       colNA         = colNA,
       legend.args   = list(text = "Fulfilled Share", side = 3, font = 1, line = 2, cex = 4),
       axis.args     = list(cex.axis = 4, at = legendbreaks, line = 0, tick = FALSE, hadj = 0.5, padj = 0.5),
       smallplot     = c(0.4, 0.75, 0.05, 0.1),
       add = T)


dev.off()

```


# Technical Irrigation Potentials

The Technical Irrigation Potentials map shows the irrigation potential 
at a yield gain threshold of 0 
on current cropland (b) and 
potential cropland (c) 
compared to actually irrigated areas according to LUH (a). 

```{r PlotTechnical, include=FALSE, echo=FALSE}
filename <- "IrrigAreaOverview"

# Area correction (only show areas where there is available irrigation area > 1% of cell size)
irrigcellshare[irrigcellshare < 0.01] <- 0

a <- collapseNames(IrrigAreaEconIRRSUScomAg[,,"0.off"])
b <- collapseNames(IrrigAreaEconCURSUScomAg[,,"0.off"])
c <- collapseNames(IrrigAreaEconPOTSUScomAg[,,"0.off"])

a[irrigcellshare == 0] <- NA
b[irrigcellshare == 0] <- NA
c[irrigcellshare == 0] <- NA

a[a == 0] <- NA
b[b == 0] <- NA
c[c == 0] <- NA

# Legend range adjustment (cell share rather than Mha)
a <- a / cellarea
b <- b / cellarea
c <- c / cellarea
legendtitle  <- "Cellshare"
legendbreaks <- seq(0, 1, 0.125)
legendcolor  <- c("#e5f5e0", "#c7e9c0", "#a1d99b", 
                  "#74c476", "#41ab5d", "#238b45", "#006d2c", "#00441b")

# Transform magpie object to raster object
a <- .toolRasterTransform(x = a)
b <- .toolRasterTransform(x = b)
c <- .toolRasterTransform(x = c)

jpeg(paste0(outputdatapath, filename, ".jpeg"), width = 8, height = 13.5, units = "in", res = 400)

par(mar = c(3, 2, 2, 2), 
    mfrow = c(3, 1), 
    bg = "transparent")

### Graph 1: LUH irrigated area (sustainable)
plot(landMask, border = "white", col = "white", ylim = ylim, xlim = xlim, asp = NA, axes = FALSE)
plot(a, ylim = ylim, xlim = xlim, asp = NA, axes = FALSE,
     legend       = FALSE,
     col          = legendcolor,
     breaks       = legendbreaks,
     colNA        = colNA,
     add          = T)
plot(landMask, border = "white", col = "white", ylim = ylim, xlim = xlim, asp = NA, axes = FALSE, add = T)
plot(worldCountries, ylim = ylim, xlim = xlim, asp = NA, axes = FALSE, add = T)
title("(a) Currently irrigated areas", outer = FALSE, cex.main = 2.5, line = 0.5)

### Graph 2: Potentially Irrigated Areas (sustainable) on current cropland
plot(landMask, border = "white", col = "white", ylim = ylim, xlim = xlim, asp = NA, axes = FALSE)
plot(b, ylim = ylim, xlim = xlim,
     legend       = FALSE,
     col          = legendcolor,
     breaks       = legendbreaks,
     colNA        = "#d9d9d9",
     add          = T)
plot(landMask, border = "white", col = "white", ylim = ylim, xlim = xlim, asp = NA, axes = FALSE, add = T)
plot(worldCountries, ylim = ylim, xlim = xlim, asp = NA, axes = FALSE, add = T)
title("(b) Potentially Irrigated Areas on current cropland", outer = FALSE, cex.main = 2.5, line = 0.5)

### Graph 3: Potentially Irrigated Areas (sustainable) on potential cropland
plot(landMask, border = "white", col = "white", ylim = ylim, xlim = xlim, asp = NA, axes = FALSE)
plot(c, ylim = ylim, xlim = xlim,
     legend       = FALSE,
     col          = legendcolor,
     breaks       = legendbreaks,
     colNA        = "#d9d9d9",
     add          = T)
plot(landMask, border = "white", col = "white", ylim = ylim, xlim = xlim, asp = NA, axes = FALSE, add = T)
plot(worldCountries, ylim = ylim, xlim = xlim, asp = NA, axes = FALSE, add = T)
title("(c) Potentially Irrigated Areas on potential cropland", outer = FALSE, cex.main = 2.5, line = 0.5)

# Legend
plot(c, bg = "transparent",
     legend.only   = TRUE,
     horizontal    = TRUE,
     col           = legendcolor,
     breaks        = legendbreaks,
     colNA         = "transparent",
     legend.args   = list(text = legendtitle, side = 3, font = 1, line = 0.1, cex = 1.2),
     axis.args     = list(cex.axis = 1.5, at = legendbreaks, line = 0.1, tick = FALSE, hadj = 0.5, padj = -0.1),
     smallplot     = c(0.35, 0.75, 0.1, 0.15),
     add = T)

dev.off()

```

# Economic Irrigation Potentials

We provide the economic irrigation maps and curves for the 
POT-SUS as well as the POT-UNSUS scenarios.

```{r ReadInEconomic, include=FALSE, echo=FALSE}
low    <- 0
middle <- 300
high   <- 600

# unsustainable land and water
x0    <- collapseNames(IrrigAreaEconPOTUNSUS[, , as.character(low)][, , "off"])
x500  <- collapseNames(IrrigAreaEconPOTUNSUS[, , as.character(middle)][, , "off"])
x1000 <- collapseNames(IrrigAreaEconPOTUNSUS[, , as.character(high)][, , "off"])

# sustainable land and water
x0sus    <- collapseNames(IrrigAreaEconPOTSUS[, , as.character(low)][, , "on"])
x500sus  <- collapseNames(IrrigAreaEconPOTSUS[, , as.character(middle)][, , "on"])
x1000sus <- collapseNames(IrrigAreaEconPOTSUS[, , as.character(high)][, , "on"])
  
```

```{r PlotEconomicPrep, include=FALSE, echo=FALSE}
filename <- "MapEconOfIrrig"

# SUS
potCropland1sus           <- dimSums(collapseNames(IrrigAreaEconPOTSUS[, , "on"]), dim = 1)
getCells(potCropland1sus) <- "GLO"
potCropland1sus           <- data.frame(y = as.numeric(as.character(as.data.frame(potCropland1sus)$Data1)),
                                        x = as.data.frame(potCropland1sus)$Value, stringsAsFactors = FALSE)

# For curve plot
x  <- potCropland1sus$x
y  <- potCropland1sus$y
a1sus <- x[y >= high]
b1sus <- y[y >= high]
a2sus <- x[y <= high & y >= middle]
b2sus <- y[y <= high & y >= middle]
a3sus <- x[y <= middle]
b3sus <- y[y <= middle]

# UNSUS
potCropland1           <- dimSums(collapseNames(IrrigAreaEconPOTUNSUS[, , "off"]), dim = 1)
getCells(potCropland1) <- "GLO"
potCropland1           <- data.frame(y = as.numeric(as.character(as.data.frame(potCropland1)$Data1)),
                                     x = as.data.frame(potCropland1)$Value, stringsAsFactors = FALSE)

# For curve plot
range <- c(0, 2000)
xCurve  <- potCropland1$x[potCropland1$y < max(range)]
yCurve  <- potCropland1$y[potCropland1$y < max(range)]
x <- potCropland1$x
y <- potCropland1$y
a1 <- x[y >= high]
b1 <- y[y >= high]
a2 <- x[y <= high & y >= middle]
b2 <- y[y <= high & y >= middle]
a3 <- x[y <= middle]
b3 <- y[y <= middle]


# PIA
x0[x0 == 0]       <- NA
x500[x500 == 0]   <- NA
x1000[x1000 == 0] <- NA

x0sus[x0sus == 0]       <- NA
x500sus[x500sus == 0]   <- NA
x1000sus[x1000sus == 0] <- NA

# Legend range adjustment
x0Share    <- x0 / cellarea
x500Share  <- x500 / cellarea
x1000Share <- x1000 / cellarea

x0Sharesus    <- x0sus / cellarea
x500Sharesus  <- x500sus / cellarea
x1000Sharesus <- x1000sus / cellarea

legendtitle  <- "Cellshare"
legendbreaks <- seq(0, 1, 0.25)

### Create and save Legend plot ###
x0_000_025 <- sum(x0[x0Share<0.25                & is.na(x500) & is.na(x1000)], na.rm = TRUE)
x0_025_050 <- sum(x0[x0Share>=0.25 & x0Share<0.5 & is.na(x500) & is.na(x1000)], na.rm = TRUE)
x0_050_075 <- sum(x0[x0Share>=0.5 & x0Share<0.75 & is.na(x500) & is.na(x1000)], na.rm = TRUE)
x0_075_010 <- sum(x0[x0Share>=0.75               & is.na(x500) & is.na(x1000)], na.rm = TRUE)

x500_000_025 <- sum(x500[x500Share<0.25                  & is.na(x1000)], na.rm = TRUE)
x500_025_050 <- sum(x500[x500Share>=0.25 & x500Share<0.5 & is.na(x1000)], na.rm = TRUE)
x500_050_075 <- sum(x500[x500Share>=0.5 & x500Share<0.75 & is.na(x1000)], na.rm = TRUE)
x500_075_010 <- sum(x500[x500Share>=0.75                 & is.na(x1000)], na.rm = TRUE)

x1000_000_025 <- sum(x1000[x1000Share<0.25], na.rm = TRUE)
x1000_025_050 <- sum(x1000[x1000Share>=0.25 & x1000Share<0.5], na.rm = TRUE)
x1000_050_075 <- sum(x1000[x1000Share>=0.5 & x1000Share<0.75], na.rm = TRUE)
x1000_075_010 <- sum(x1000[x1000Share>=0.75], na.rm = TRUE)

x0_000_025sus <- sum(x0sus[x0Sharesus<0.25                   & is.na(x500sus) & is.na(x1000sus)], na.rm = TRUE)
x0_025_050sus <- sum(x0sus[x0Sharesus>=0.25 & x0Sharesus<0.5 & is.na(x500sus) & is.na(x1000sus)], na.rm = TRUE)
x0_050_075sus <- sum(x0sus[x0Sharesus>=0.5 & x0Sharesus<0.75 & is.na(x500sus) & is.na(x1000sus)], na.rm = TRUE)
x0_075_010sus <- sum(x0sus[x0Sharesus>=0.75                  & is.na(x500sus) & is.na(x1000sus)], na.rm = TRUE)

x500_000_025sus <- sum(x500sus[x500Sharesus<0.25                     & is.na(x1000sus)], na.rm = TRUE)
x500_025_050sus <- sum(x500sus[x500Sharesus>=0.25 & x500Sharesus<0.5 & is.na(x1000sus)], na.rm = TRUE)
x500_050_075sus <- sum(x500sus[x500Sharesus>=0.5 & x500Sharesus<0.75 & is.na(x1000sus)], na.rm = TRUE)
x500_075_010sus <- sum(x500sus[x500Sharesus>=0.75                    & is.na(x1000sus)], na.rm = TRUE)

x1000_000_025sus <- sum(x1000sus[x1000Sharesus<0.25], na.rm = TRUE)
x1000_025_050sus <- sum(x1000sus[x1000Sharesus>=0.25 & x1000Sharesus<0.5], na.rm = TRUE)
x1000_050_075sus <- sum(x1000sus[x1000Sharesus>=0.5 & x1000Sharesus<0.75], na.rm = TRUE)
x1000_075_010sus <- sum(x1000sus[x1000Sharesus>=0.75], na.rm = TRUE)

colors <- c("#edf8fb", "#b2e2e2", "#66c2a4", "#238b45", # color-blind safe
            "#f2f0f7", "#cbc9e2", "#9e9ac8", "#6a51a3",
            "#feedde", "#fdbe85", "#fd8d3c", "#d94701")
values <- c(x0_000_025, x0_025_050, x0_050_075, x0_075_010,
          x500_000_025, x500_025_050, x500_050_075, x500_075_010,
          x1000_000_025, x1000_025_050, x1000_050_075, x1000_075_010)

valuessus <- c(x0_000_025sus, x0_025_050sus, x0_050_075sus, x0_075_010sus,
          x500_000_025sus, x500_025_050sus, x500_050_075sus, x500_075_010sus,
          x1000_000_025sus, x1000_025_050sus, x1000_050_075sus, x1000_075_010sus)

.boxes <- function(position = c(0, 0, 0.25, 1), color = "#edf8fb", text = "some Mha") {
  rect(position[1], position[2], position[3], position[4], border = "black", col = color)
  text(min(c(position[1], position[3]))+0.03, mean(c(position[2], position[4])), text, cex = 3.5, adj = c(0, 0.5))
}

```

```{r PlotEconomicUNSUS, include=FALSE, echo=FALSE}
# Area correction (exclude small areas) for map visualization 
x0Share[irrigcellshare == 0]    <- NA
x500Share[irrigcellshare == 0]  <- NA
x1000Share[irrigcellshare == 0] <- NA

# Transform magpie object to raster object
x0Share        <- .toolRasterTransform(x0Share)
x500Share      <- .toolRasterTransform(x500Share)
x1000Share     <- .toolRasterTransform(x1000Share)

### Create and save Map plot for UNSUS scenario ###
jpeg(paste0(outputdatapath, filename, "_a.jpeg"), width = 200, height = 120, units = "mm", res = 400)

# Plot Map
par(mar = c(0, 0, 0, 0), oma = c(0, 0, 0, 0))
plot(landMask, border = "white", col = "white", ylim = ylim, xlim = xlim, asp = NA, 
     axes = FALSE)

plot(x0Share, bg = "transparent", ylim = ylim, xlim = xlim, asp = NA, 
     axes = FALSE,
     legend       = FALSE,
     col          = c("#edf8fb", "#b2e2e2", "#66c2a4", "#238b45"), # green-ish color scale
     breaks       = legendbreaks,
     colNA        = NA,
     add = T)

plot(x500Share, bg = "transparent", ylim = ylim, xlim = xlim, asp = NA, 
     axes = FALSE,
     legend       = FALSE,
     col          = c("#f2f0f7", "#cbc9e2", "#9e9ac8", "#6a51a3"), # violet-ish color scale; 
     breaks       = legendbreaks,
     colNA        = NA,
     add          = T)

plot(x1000Share, bg = "transparent", ylim = ylim, xlim = xlim, asp = NA, 
     axes = FALSE,
     legend       = FALSE,
     col          = c("#feedde", "#fdbe85", "#fd8d3c", "#d94701"), # orange-ish color scale; 
     breaks       = legendbreaks,
     colNA        = NA,
     add          = T)

plot(landMask, border = "white", col = "white", ylim = ylim, xlim = xlim, asp = NA, axes = FALSE, add = T)
plot(worldCountries, ylim = ylim, xlim = xlim, asp = NA, axes = FALSE, add = T)

title("a) POT-UNSUS", cex.main = 1.5, line = 0.5, adj = 0)

dev.off()
```

```{r PlotEconomicSUS, include=FALSE, echo=FALSE}
# Area correction (exclude small areas) for map visualization 
x0Sharesus[irrigcellshare == 0]    <- NA
x500Sharesus[irrigcellshare == 0]  <- NA
x1000Sharesus[irrigcellshare == 0] <- NA

# Transform magpie object to raster object
x0Sharesus        <- .toolRasterTransform(x0Sharesus)
x500Sharesus      <- .toolRasterTransform(x500Sharesus)
x1000Sharesus     <- .toolRasterTransform(x1000Sharesus)

### Create and save Map plot for SUS scenario ###
jpeg(paste0(outputdatapath, filename, "_b.jpeg"), width = 200, height = 120, units = "mm", res = 400)

# Plot Map
par(mar = c(0, 0, 0, 0), oma = c(0, 0, 0, 0))
plot(landMask, border = "white", col = "white", ylim = ylim, xlim = xlim, asp = NA, axes = FALSE)

plot(x0Sharesus, bg = "transparent", ylim = ylim, xlim = xlim,
     asp = NA, axes = FALSE,
     legend       = FALSE,
     col          = c("#edf8fb", "#b2e2e2", "#66c2a4", "#238b45"), # green-ish color scale
     breaks       = legendbreaks,
     colNA        = NA,
     add = T)

plot(x500Sharesus, bg = "transparent", ylim = ylim, xlim = xlim,
     asp = NA, axes = FALSE,
     legend       = FALSE,
     col          = c("#f2f0f7", "#cbc9e2", "#9e9ac8", "#6a51a3"), # violet-ish color scale; 
     breaks       = legendbreaks,
     colNA        = NA,
     add          = T)

plot(x1000Sharesus, bg = "transparent", ylim = ylim, xlim = xlim,
     asp = NA, axes = FALSE,
     legend       = FALSE,
     col          = c("#feedde", "#fdbe85", "#fd8d3c", "#d94701"), # orange-ish color scale; 
     breaks       = legendbreaks,
     colNA        = NA,
     add          = T)

plot(landMask, border = "white", col = "white", ylim = ylim, xlim = xlim, asp = NA, axes = FALSE, add = T)
plot(worldCountries, ylim = ylim, xlim = xlim, asp = NA, axes = FALSE, add = T)

title("b) POT-SUS", cex.main = 1.5, line = 0.5, adj = 0)

dev.off()
```

```{r PlotEconomicCurve, include=FALSE, echo=FALSE}
# Curve Plot
pdf(paste0(outputdatapath, filename, "_c.pdf"), height = 9, width = 26)

par(fig = c(0.03, 0.45, 0, 1), bg = "white", new = FALSE,
    mar = c(7, 7, 5, 1), xaxs = "i", yaxs = "i")
plot(xCurve, yCurve, bg = "white",
     col = ifelse(y > high, "#fd8d3c", ifelse(y > middle, "#6a51a3", "#66c2a4")),
     main = "",
     xlab = "",
     ylab = "",
     cex.lab = 3.5,
     type = "p", pch = 19, lty = 1, lwd = 2.5,
     bty = "l", yaxt = "n", xaxt = "n")
s <- seq(length(a1)-1)
segments(a1[s], b1[s], a1[s+1], b1[s+1], col= "#fd8d3c", lwd = 8)
s <- seq(length(a2)-1)
segments(a2[s], b2[s], a2[s+1], b2[s+1], col= "#6a51a3", lwd = 8)
s <- seq(length(a3)-1)
segments(a3[s], b3[s], a3[s+1], b3[s+1], col= "#66c2a4", lwd = 8)
text(1000, 750, "POT-UNSUS", col = "black", cex = 3)

s <- seq(length(a1sus)-1)
segments(a1sus[s], b1sus[s], a1sus[s+1], b1sus[s+1], col = "#fdbe85", lwd = 8)
s <- seq(length(a2sus)-1)
segments(a2sus[s], b2sus[s], a2sus[s+1], b2sus[s+1], col = "#cbc9e2", lwd = 8)
s <- seq(length(a3sus)-1)
segments(a3sus[s], b3sus[s], a3sus[s+1], b3sus[s+1], col = "#b2e2e2", lwd = 8)
text(550, 200, "POT-SUS", col = "black", cex = 3)

axis(side = 1, cex.axis = 3, hadj = 0.5, padj = 0.5,
   at = c(seq(from = 0, to = max(potCropland1$x), by = 500))) # x axis
axis(side = 2, cex.axis = 3, hadj = 1, padj = 0.5,
   at = c(seq(from = 0, to = 3000, by = 300)), las = 1)      # y axis
mtext("Irrigation yield gain (in USD/ha)", side = 2, line = 7, cex = 3.5)
mtext("Irrigated area (in Mha)", side = 1, line = 5.5, cex = 3.5)
#title("Global \nPotentially Irrigated Areas \non potential cropland", cex.main = 3, line = -5, adj = 0.1)
title("c)", cex.main = 4.5, line = 2, adj = 0)

# Legend UNSUS
par(mar = c(1, 1, 1, 1), fig = c(0.6, 0.9, 0.6, 0.9), new = TRUE)
plot(c(0, 1), c(0, 3), type = "n", xlab = "", ylab = "", axes = FALSE)
axis(side = 1, col = NA, col.ticks = NA, at = legendbreaks, cex.axis = 3, padj = 0.6)
axis(side = 2, col = NA, col.ticks = NA, at = c(1, 2, 3), cex.axis = 3,
   hadj = 1, padj = 1.4, c(paste0(">", low, "-", middle, "USD/ha"), 
                           paste0(">", middle, "-", high, "USD/ha"), 
                           paste0(">", high, "USD/ha")), 
   las = 2)
mtext("PIA for POT-UNSUS (in Mha)", side = 3, line = 0.5, cex = 3.5)

i <- 0
for (threshold in c(1, 2, 3)) {
for (share in c(0.25, 0.5, 0.75, 1)) {
  i <- i + 1
  .boxes(position = c(share-0.25, threshold-1, share, threshold),
         color = colors[i], text = paste0(round(values[i]), ""))
 }
}

# Legend SUS
par(mar = c(1, 1, 1, 1), fig = c(0.6, 0.9, 0.15, 0.45), new = TRUE)
plot(c(0, 1), c(0, 3), type = "n", xlab = "", ylab = "", axes = FALSE)
axis(side = 1, col = NA, col.ticks = NA, at = legendbreaks, cex.axis = 3, padj = 0.6)
axis(side = 2, col = NA, col.ticks = NA, at = c(1, 2, 3), cex.axis = 3,
   hadj = 1, padj = 1.4, c(paste0(">", low, "-", middle, "USD/ha"), 
                           paste0(">", middle, "-", high, "USD/ha"), 
                           paste0(">", high, "USD/ha")), 
   las = 2)
mtext("Cell share", side = 1, line = 6, cex = 3.2)
mtext("PIA for POT-SUS (in Mha)", side = 3, line = 0.5, cex = 3.5)


i <- 0
for (threshold in c(1, 2, 3)) {
for (share in c(0.25, 0.5, 0.75, 1)) {
  i <- i + 1
  .boxes(position = c(share-0.25, threshold-1, share, threshold),
         color = colors[i], text = paste0(round(valuessus[i]), ""))
 }
}

dev.off()

```


# Supplementary Material

## Discharge Accessibility

The more variable the discharge, the harder it is accessible to humans. 
This graph visualizes the relationship between discharge and accessibility.

```{r FunctionalRelationshipGraph, include=FALSE, echo=FALSE}
# Inputdata
input <- "LPJmL_monthlyDischarge"

# Read in data
monthlyD <- read.magpie(paste0(inputdatapath, input, ".mz"))
coeff    <- 2

# Extract years
years <- getYears(monthlyD, as.integer = TRUE)
if (class(year) != "numeric") {
  year <- as.numeric(gsub("y", "", year))
}

for (y in year) {

  # Long-term reference time frame for discharge variability calculation
  if ((y - 30) > years[1]) {
    longterm_period <- seq(y - 30, y, by = 1)
  } else {
    longterm_period <- seq(1980, 2010, by = 1)
  }
  monthly_discharge <- monthlyD[, longterm_period, ]

  # Transform to array (faster calculation)
  monthly_discharge <- as.array(collapseNames(monthly_discharge))

  ### Variation Coefficient Method ###
  # Mean and standard deviation of discharge
  mean_discharge <- apply(monthly_discharge, MARGIN = 1, mean)
  std_discharge  <- apply(monthly_discharge, MARGIN = 1, sd)

  # Coefficient of Variation
  cv <- ifelse(mean_discharge > 0, std_discharge / mean_discharge, 0)
}

x <- seq(min(cv), max(cv), by = 1)

### Create and save plot ###
pdf(paste0(outputdatapath, "AccessibilityRule", ".pdf"), height = 21.0, width = 29.7, paper = "a4r")
par(mfrow = c(2, 1),
    mar = c(4.1, 4.1, 4.1, 2.1))

hist(cv, breaks = 100, main = NULL,
     xlab = "Coefficient of variation of monthly discharge (std.deviation/mean)",
     ylab = "Frequency (Number of grid cells)",
     yaxs = "i",
    col = "lightblue")
axis(side = 1, at = seq(min(cv), max(cv), by = 1)) # x axis
title("(a)", adj = 0)

plot(coeff^(-x),
   type = "l",
   xlab = "Coefficient of variation of monthly discharge (std.deviation/mean)",
   ylab = "Accessible share of discharge",
   cex.lab = 1,
   xlim = c(min(x), max(x)), ylim = c(0, 1),
   #xaxs = "i",
   yaxs = "i",
   lwd = 4, col = "blue")
axis(side = 1, at = seq(min(cv), max(cv), by = 1)) # x axis
axis(side = 2, at = seq(0, 1, by = 0.1))  # y axis
title("(b)", adj = 0)

dev.off()

```

## Protected Areas according to Half Earth Scenario

```{r ProtectedAreaReadin, include=TRUE, echo=FALSE}
potlandUnprotect <- read.magpie(paste0(inputdatapath, "avlIrrigarea_pot.mz"))

print(paste0("Non-protected areas that are suitable for cropland activities: ", dimSums(potlandUnprotect, dim = 1)))
```

The Protected Areas map shows the share of each grid cell that is protected following the Half Earth scenario. 

```{r HalfEarth, include=FALSE, echo=FALSE}
protectSCEN <- "HalfEarth"

# Read in data
protectArea <- collapseNames(read.magpie(paste0(inputdatapath, "protectedAreas.mz"))[, , protectSCEN])

# Cell share that is protected
protectArea <- protectArea / cellarea

# Plot Fulfilled Share
legendtitle  <- "Protected Share"
legendbreaks <- seq(0, 1, 0.125)
legendcolor  <- c("#FFFFFF", "#d9f0a3", "#addd8e",
                  "#78c679", "#41ab5d", "#238443", "#006837", "#004529")

# Transform magpie object to raster object
protectArea <- .toolRasterTransform(protectArea)
# correct rounding
protectArea[protectArea < 0] <- 0
protectArea[protectArea > 1] <- 1

jpeg(paste0(outputdatapath, "ProtectArea", ".jpeg"), width = 8, height = 4.5, units = "in", res = 400)

plot(landMask, border = "white", col = "white", ylim = ylim, xlim = xlim, asp = NA, axes = FALSE)
plot(protectArea, ylim = ylim, xlim = xlim, asp = NA, axes = FALSE,
     legend       = FALSE,
     col          = legendcolor,
     breaks       = legendbreaks,
     colNA        = colNA,
     add          = T)
plot(landMask, border = "white", col = "white", ylim = ylim, xlim = xlim, asp = NA, axes = FALSE, add = T)
plot(worldCountries, ylim = ylim, xlim = xlim, asp = NA, axes = FALSE, add = T)

# Legend
plot(protectArea, bg = "transparent",
     legend.only   = TRUE,
     horizontal    = TRUE,
     col           = legendcolor,
     breaks        = legendbreaks,
     colNA         = "transparent",
     legend.args   = list(text = legendtitle, side = 3, font = 1, line = 0.5, cex = 1),
     axis.args     = list(cex.axis = 1, at = legendbreaks, line = 0, tick = FALSE, hadj = 0.4, padj = -1.2),
     smallplot     = c(0.4, 0.75, 0.1, 0.15),
     add = T)

dev.off()

```

## Validation of yield gain (in USD/ha)

```{r YieldGain, include=TRUE, echo=FALSE}

# Yield gain in USD/ha with global average prices
yieldGain_GLO   <- dimSums(read.magpie(paste0(inputdatapath, "yieldgain_USDha_GLO", ".mz")), dim = 3)
yieldGain_ISO   <- dimSums(read.magpie(paste0(inputdatapath, "yieldgain_USDha_ISO", ".mz")), dim = 3)
yieldGain_const <- dimSums(read.magpie(paste0(inputdatapath, "yieldgain_USDha_constant", ".mz")), dim = 3)

getSets(yieldGain_GLO)   <- c("x", "y", "iso", "year", "data")
getSets(yieldGain_ISO)   <- c("x", "y", "iso", "year", "data")
getSets(yieldGain_const) <- c("x", "y", "iso", "year", "data")

# Summary statistics
summary(yieldGain_GLO)
summary(yieldGain_ISO)
summary(yieldGain_const)

# For the main results, we use global average food prices:
yieldGain <- yieldGain_GLO

# Area masks (ACT, CUR, POT with sufficient water)
yldGainACT   <- dimSums(yieldGain * IrrigAreaEconIRRUNSUS[,,"0.off"], dim = 1) / dimSums(IrrigAreaEconIRRUNSUS[,,"0.off"], dim = 1)
yldGainCUR   <- dimSums(yieldGain * IrrigAreaEconCURUNSUS[,,"0.off"], dim = 1) / dimSums(IrrigAreaEconCURUNSUS[,,"0.off"], dim = 1)
yldGainCURrf <- dimSums(yieldGain * (collapseNames(IrrigAreaEconCURUNSUS[,,"0.off"])-LUHirrigated), dim = 1) /
                            dimSums((collapseNames(IrrigAreaEconCURUNSUS[,,"0.off"])-LUHirrigated), dim = 1)
yldGainPOT    <- dimSums(yieldGain * IrrigAreaEconPOTUNSUS[,,"0.off"], dim = 1) / dimSums(IrrigAreaEconPOTUNSUS[,,"0.off"], dim = 1)
yldGainPOTsus <- dimSums(yieldGain * IrrigAreaEconPOTSUS[,,"0.off"], dim = 1) / dimSums(IrrigAreaEconPOTSUS[,,"0.off"], dim = 1)

# Area masks (ACT, CUR, POT)
tmpIrrig    <- dimSums(yieldGain * LUHirrigated, dim = 1) / dimSums(LUHirrigated, dim = 1)
tmpCropland <- dimSums(yieldGain * LUHtotal, dim = 1) / dimSums(LUHtotal, dim = 1)
tmpRainfed  <- dimSums(yieldGain * (LUHtotal-LUHirrigated), dim = 1) / dimSums((LUHtotal-LUHirrigated), dim = 1)
tmpPotTotal <- dimSums(yieldGain * yieldgainareaPOTunsus[,,"0"], dim = 1) / dimSums(yieldgainareaPOTunsus[,,"0"], dim = 1)
tmpPotSus   <- dimSums(yieldGain * yieldgainareaPOTsus[,,"0"], dim = 1) / dimSums(yieldgainareaPOTsus[,,"0"], dim = 1)

# In-text numbers (global)
writeLines(paste0("The average yield  gain on currently irrigated areas is ", round(tmpIrrig, digits = 1), "USD per hectare.", 
"\nTaking only those areas into account where sufficient local water resources are available \nafter optimization, the yield gain on currently irrigated areas is ", round(yldGainACT),                 
"\nThe average yield gain on current cropland is ", round(mean(tmpCropland), digits = 1), "USD per hectare.",
"\nTaking only those areas into account where sufficient local water resources are available \nafter optimization, the yield gain on current croparea is ", round(yldGainCUR),  
"\nThe average yield gain on current cropland that is currently not under irrigation, \nbut would be irrigated according to our algorithm is ", round(mean(yldGainCURrf), digits = 1), "USD per hectare.",
"\nThe average yield gain on currently rainfed cropland is ", round(mean(tmpRainfed), digits = 1), "USD per hectare.",
"\nThe average yield gain on total potential cropland is ", round(mean(tmpPotTotal), digits = 1), ".",
"\nTaking only those areas into account where sufficient local water resources are available \nafter optimization, the yield gain on potential cropland areas is ", round(yldGainPOT),
"\nThe average yield gain on potential (unprotected) cropland is ", round(mean(tmpPotSus), digits = 1), ".",
"\nTaking only those areas into account where sufficient local water resources are available \nafter optimization, the yield gain on potential cropland areas is ", round(yldGainPOTsus)))


# Spearman correlation
corrAandB <- round(cor.test(yieldGain_GLO, yieldGain_ISO, method = "spearman")$estimate, digits = 4)
corrAandC <- round(cor.test(yieldGain_GLO, yieldGain_const, method = "spearman")$estimate, digits = 4)

# Area-weighted histogram
yieldGain_GLO[yieldGain_GLO > 1200]     <- 1200
yieldGain_ISO[yieldGain_ISO > 1200]     <- 1200
yieldGain_const[yieldGain_const > 1200] <- 1200


pdf(paste0(outputdatapath, "Histograms_yieldvaluegain", ".pdf"), height = 15, width = 29.7, paper = "a4r")
par(mfrow = c(1, 3), mar = c(5,8,3,2))
weighted.hist(x = yieldGain_GLO, w = yieldgainareaPOTunsus[,,"0"],
              breaks = c(0, 200, 400, 600, 800, 1000, 1200), ylim = c(0, 3000), col = "#fcbba1", 
              main = "(a) Global average commodity prices\n", ylab = "Yield gain area (in Mha)\n", 
              cex.lab = 2, cex.axis = 1.5, cex.names = 6, cex.main = 1.5)
weighted.hist(x = yieldGain_ISO, w = yieldgainareaPOTunsus[,,"0"], 
              breaks = c(0, 200, 400, 600, 800, 1000, 1200), ylim = c(0, 3000), col = "#fcbba1", 
              main = "(b) Country-level commodity prices\n", ylab = "", 
              cex.axis = 1.5, cex.names = 6, cex.main = 1.5)
text(x = 800, y = 2500, paste0("Spearman's rho: \n", corrAandB), cex = 2)
weighted.hist(x = yieldGain_const, w = yieldgainareaPOTunsus[,,"0"], 
              breaks = c(0, 200, 400, 600, 800, 1000, 1200), ylim = c(0, 3000), col = "#fcbba1", 
              main = "(c) Constant global price\n", ylab = "", 
              cex.axis = 1.5, cex.names = 6, cex.main = 1.5)
text(x = 800, y = 2500, paste0("Spearman's rho: \n", corrAandC), cex = 2)
par(mfrow = c(1, 1))
dev.off()


# Legend
legendbreaks <- c(0, 100, 300, 500, 700, 900, 1000)
legendbreaks <- c(0, 200, 400, 600, 800, 1000, 1200)
legendcolor  <- c("#FFFFFF", "#fdbb84", "#fc8d59", "#d7301f", "#b30000", "#7f0000")

# Transform magpie object to raster object
yieldGain_GLO   <- .toolRasterTransform(yieldGain_GLO)
yieldGain_ISO   <- .toolRasterTransform(yieldGain_ISO)
yieldGain_const <- .toolRasterTransform(yieldGain_const)

yieldGain_GLO[yieldGain_GLO < 0]     <- 0
yieldGain_GLO[yieldGain_GLO >= 1200] <- 1199

yieldGain_ISO[yieldGain_ISO < 0]     <- 0
yieldGain_ISO[yieldGain_ISO >= 1200] <- 1199

yieldGain_const[yieldGain_const < 0]     <- 0
yieldGain_const[yieldGain_const >= 1200] <- 1199


# Global average prices:
jpeg(paste0(outputdatapath, "Yields", ".jpeg"), width = 8, height = 4.5, units = "in", res = 400)

plot(landMask, border = "white", col = "white", ylim = ylim, xlim = xlim, asp = NA, axes = FALSE)
plot(yieldGain_GLO, ylim = ylim, xlim = xlim, asp = NA, axes = FALSE,
     legend       = FALSE,
     col          = legendcolor,
     breaks       = legendbreaks,
     colNA        = colNA,
     add          = T)
plot(landMask, border = "white", col = "white", ylim = ylim, xlim = xlim, asp = NA, axes = FALSE, add = T)
plot(worldCountries, ylim = ylim, xlim = xlim, asp = NA, axes = FALSE, add = T)

# Legend
plot(yieldGain_GLO, bg = "transparent",
     legend.only   = TRUE,
     horizontal    = TRUE,
     col           = legendcolor,
     breaks        = legendbreaks,
     colNA         = "transparent",
     legend.args   = list(text = "USD per ha", side = 3, font = 1, line = 0.5, cex = 1),
     axis.args     = list(cex.axis = 0.8, at = legendbreaks, line = 0, tick = FALSE, hadj = 0.4, padj = -1.5),
     smallplot     = c(0.4, 0.75, 0.1, 0.15),
     add = T)

dev.off()


# Global average prices:
jpeg(paste0(outputdatapath, "Yields_iso", ".jpeg"), width = 8, height = 4.5, units = "in", res = 400)

plot(landMask, border = "white", col = "white", ylim = ylim, xlim = xlim, asp = NA, axes = FALSE)
plot(yieldGain_ISO, ylim = ylim, xlim = xlim, asp = NA, axes = FALSE,
     legend       = FALSE,
     col          = legendcolor,
     breaks       = legendbreaks,
     colNA        = colNA,
     add          = T)
plot(landMask, border = "white", col = "white", ylim = ylim, xlim = xlim, asp = NA, axes = FALSE, add = T)
plot(worldCountries, ylim = ylim, xlim = xlim, asp = NA, axes = FALSE, add = T)

# Legend
plot(yieldGain_ISO, bg = "transparent",
     legend.only   = TRUE,
     horizontal    = TRUE,
     col           = legendcolor,
     breaks        = legendbreaks,
     colNA         = "transparent",
     legend.args   = list(text = "USD per ha", side = 3, font = 1, line = 0.5, cex = 1),
     axis.args     = list(cex.axis = 0.8, at = legendbreaks, line = 0, tick = FALSE, hadj = 0.4, padj = -1.5),
     smallplot     = c(0.4, 0.75, 0.1, 0.15),
     add = T)

dev.off()


# Global average prices:
jpeg(paste0(outputdatapath, "Yields_constant", ".jpeg"), width = 8, height = 4.5, units = "in", res = 400)

plot(landMask, border = "white", col = "white", ylim = ylim, xlim = xlim, asp = NA, axes = FALSE)
plot(yieldGain_const, ylim = ylim, xlim = xlim, asp = NA, axes = FALSE,
     legend       = FALSE,
     col          = legendcolor,
     breaks       = legendbreaks,
     colNA        = colNA,
     add          = T)
plot(landMask, border = "white", col = "white", ylim = ylim, xlim = xlim, asp = NA, axes = FALSE, add = T)
plot(worldCountries, ylim = ylim, xlim = xlim, asp = NA, axes = FALSE, add = T)

# Legend
plot(yieldGain_const, bg = "transparent",
     legend.only   = TRUE,
     horizontal    = TRUE,
     col           = legendcolor,
     breaks        = legendbreaks,
     colNA         = "transparent",
     legend.args   = list(text = "USD per ha", side = 3, font = 1, line = 0.5, cex = 1),
     axis.args     = list(cex.axis = 0.8, at = legendbreaks, line = 0, tick = FALSE, hadj = 0.4, padj = -1.5),
     smallplot     = c(0.4, 0.75, 0.1, 0.15),
     add = T)

dev.off()

```

